<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Code Lookup ‚Äî ICD-10 ¬∑ SNOMED CT ¬∑ LOINC ¬∑ ATC ¬∑ RxCUI ¬∑ CPT ¬∑ HCPCS ¬∑ NDC</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] } } }
    }
  </script>
  <style>
    .text-gradient{background:linear-gradient(135deg,#c4b5fd 0%,#a78bfa 40%,#7c3aed 70%,#ec4899 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    :root{
      --c-card:#fff;--c-card-border:#e5e7eb;--c-card-shadow:rgba(139,92,246,.07);
      --c-text:#1e1b4b;--c-text-muted:#6b7280;--c-text-dim:#9ca3af;
      --c-primary:#8b5cf6;--c-primary-soft:rgba(139,92,246,.08);--c-accent:#7c3aed;
      --c-badge-bg:rgba(139,92,246,.1);--c-badge-fg:#7c3aed;
      --c-badge-teal-bg:rgba(20,184,166,.1);--c-badge-teal-fg:#0d9488;
      --c-err-bg:#fef2f2;--c-err-fg:#b91c1c;--c-err-border:#fecaca;
      --c-ok-bg:#f0fdf4;--c-ok-fg:#166534;--c-ok-border:#bbf7d0;
      --c-warn-bg:#fffbeb;--c-warn-fg:#92400e;--c-warn-border:#fde68a;
      --c-input-bg:#fff;--c-input-border:#d1d5db;--c-input-fg:#1e1b4b;
      --c-chip-bg:rgba(139,92,246,.07);--c-chip-border:rgba(139,92,246,.18);--c-chip-fg:#7c3aed;
      --c-pill-bg:#f3f4f6;--c-pill-border:#e5e7eb;--c-pill-fg:#6b7280;
      --c-pill-on-bg:#8b5cf6;--c-pill-on-fg:#fff;--c-pill-on-border:#8b5cf6;
      --c-si-bg:#fff;--c-si-border:#e5e7eb;
      --c-orb-opacity:0;--c-canvas-opacity:0;
    }
    html.dark{
      --c-card:rgba(255,255,255,.06);--c-card-border:rgba(255,255,255,.1);--c-card-shadow:rgba(0,0,0,.25);
      --c-text:#f1eeff;--c-text-muted:#9b8ec4;--c-text-dim:#6b5e8a;
      --c-primary:#a78bfa;--c-primary-soft:rgba(167,139,250,.15);--c-accent:#7c3aed;
      --c-badge-bg:rgba(167,139,250,.15);--c-badge-fg:#a78bfa;
      --c-badge-teal-bg:rgba(20,184,166,.15);--c-badge-teal-fg:#5eead4;
      --c-err-bg:rgba(239,68,68,.15);--c-err-fg:#fca5a5;--c-err-border:rgba(239,68,68,.3);
      --c-ok-bg:rgba(16,185,129,.15);--c-ok-fg:#6ee7b7;--c-ok-border:rgba(16,185,129,.3);
      --c-warn-bg:rgba(251,191,36,.1);--c-warn-fg:#fcd34d;--c-warn-border:rgba(251,191,36,.2);
      --c-input-bg:rgba(255,255,255,.06);--c-input-border:rgba(255,255,255,.1);--c-input-fg:#f1eeff;
      --c-chip-bg:rgba(167,139,250,.12);--c-chip-border:rgba(167,139,250,.25);--c-chip-fg:#a78bfa;
      --c-pill-bg:rgba(255,255,255,.06);--c-pill-border:rgba(255,255,255,.1);--c-pill-fg:#9b8ec4;
      --c-pill-on-bg:#8b5cf6;--c-pill-on-fg:#fff;--c-pill-on-border:#8b5cf6;
      --c-si-bg:rgba(255,255,255,.04);--c-si-border:rgba(255,255,255,.1);
      --c-orb-opacity:.3;--c-canvas-opacity:1;
    }
    #bgCanvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;opacity:var(--c-canvas-opacity);transition:opacity .5s}
    .bg-gradient-orbs{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;overflow:hidden}
    .bg-gradient-orbs .orb{position:absolute;border-radius:50%;filter:blur(80px);opacity:var(--c-orb-opacity);transition:opacity .5s;animation:orbFloat 20s ease-in-out infinite}
    .bg-gradient-orbs .orb:nth-child(1){width:600px;height:600px;background:#7C3AED;top:-10%;left:-5%;animation-duration:25s}
    .bg-gradient-orbs .orb:nth-child(2){width:500px;height:500px;background:#6D28D9;bottom:-10%;right:-5%;animation-delay:-5s;animation-duration:30s}
    .bg-gradient-orbs .orb:nth-child(3){width:400px;height:400px;background:#4C1D95;top:40%;left:50%;animation-delay:-10s;animation-duration:22s}
    @keyframes orbFloat{0%,100%{transform:translate(0,0) scale(1)}25%{transform:translate(40px,-30px) scale(1.05)}50%{transform:translate(-20px,20px) scale(.95)}75%{transform:translate(30px,40px) scale(1.02)}}
    .spinner{display:inline-block;width:1.1rem;height:1.1rem;border:2px solid rgba(255,255,255,.2);border-top-color:var(--c-primary);border-radius:50%;animation:spin .8s linear infinite;margin-right:.5rem;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    .radio-group{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:.5rem}
    .radio-group input{display:none}
    .radio-group label{display:inline-flex;align-items:center;padding:.6rem 1.15rem;border-radius:50px;background:var(--c-pill-bg);color:var(--c-pill-fg);font-size:.9rem;font-weight:500;cursor:pointer;border:1px solid var(--c-pill-border);transition:all .25s}
    .radio-group label:hover{border-color:var(--c-accent);color:var(--c-primary)}
    .radio-group input:checked+label{background:var(--c-pill-on-bg);color:var(--c-pill-on-fg);border-color:var(--c-pill-on-border);box-shadow:0 0 16px rgba(139,92,246,.3)}
    .info-banner{margin-top:.75rem;padding:.85rem 1.1rem;background:var(--c-primary-soft);border-radius:10px;border-left:3px solid var(--c-accent);font-size:.875rem;line-height:1.5;color:var(--c-text-muted);transition:opacity .25s}
    .info-banner.fade-in{animation:fadeIn .3s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .input-row{display:flex;flex-wrap:wrap;gap:.75rem;align-items:center}
    .input-row input[type="text"]{flex:1;min-width:220px;padding:.9rem 1.15rem;font-size:1.05rem;font-family:inherit;font-weight:500;border:1px solid var(--c-input-border);border-radius:12px;background:var(--c-input-bg);color:var(--c-input-fg);transition:all .25s}
    .input-row input[type="text"]::placeholder{color:var(--c-text-dim)}
    .input-row input[type="text"]:focus{outline:none;border-color:var(--c-primary);box-shadow:0 0 0 3px rgba(139,92,246,.15)}
    .btn{padding:.9rem 1.75rem;font-size:1rem;font-weight:600;font-family:inherit;border:none;border-radius:12px;cursor:pointer;color:#fff;background:linear-gradient(135deg,#7c3aed,#8b5cf6);box-shadow:0 4px 14px rgba(124,58,237,.3);transition:all .25s}
    .btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 20px rgba(124,58,237,.4)}
    .btn:active:not(:disabled){transform:translateY(0)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .chip{display:inline-block;padding:.4rem .9rem;border-radius:50px;font-size:.85rem;font-family:inherit;font-weight:500;background:var(--c-chip-bg);color:var(--c-chip-fg);border:1px solid var(--c-chip-border);cursor:pointer;margin:.25rem .2rem 0 0;transition:all .2s}
    .chip:hover{background:var(--c-primary-soft);border-color:var(--c-primary);transform:translateY(-1px)}
    .examples{margin-top:.75rem}
    .examples span{font-size:.875rem;color:var(--c-text-dim);margin-right:.4rem}
    .result-card{background:var(--c-card);border-radius:16px;border:1px solid var(--c-card-border);border-left:4px solid var(--c-accent);box-shadow:0 8px 24px var(--c-card-shadow);padding:1.75rem 2rem;margin:1.5rem 0;animation:slideUp .35s ease}
    @keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    .result-card .display-name{font-size:1.75rem;font-weight:700;color:var(--c-text);margin:0 0 .75rem 0;line-height:1.3}
    .result-card .badges{margin-bottom:.75rem}
    .result-card .badge{display:inline-block;padding:.25rem .65rem;border-radius:6px;font-size:.78rem;font-weight:600;margin-right:.4rem;background:var(--c-badge-bg);color:var(--c-badge-fg)}
    .result-card .badge-teal{background:var(--c-badge-teal-bg);color:var(--c-badge-teal-fg)}
    .result-card .source-label{font-size:.7rem;font-weight:600;color:var(--c-text-dim);text-transform:uppercase;letter-spacing:1px;margin:1rem 0 .25rem 0}
    .result-card .source-value{color:var(--c-text-muted);font-size:.9rem;margin:0}
    .message{padding:1rem 1.15rem;border-radius:12px;margin:1rem 0;font-size:.9rem;border:1px solid transparent}
    .message.error{background:var(--c-err-bg);color:var(--c-err-fg);border-color:var(--c-err-border)}
    .message.success{background:var(--c-ok-bg);color:var(--c-ok-fg);border-color:var(--c-ok-border)}
    .conversion-section{margin-top:24px}
    .conversion-divider{border:none;border-top:1px solid var(--c-card-border);margin:0 0 16px 0}
    .conversion-heading{text-align:center;font-size:.75rem;color:var(--c-text-dim);text-transform:uppercase;letter-spacing:2px;margin:0 0 16px 0;font-weight:500}
    .conversion-buttons{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
    .conversion-buttons .chip{min-height:44px;min-width:44px}
    .conversion-result-card{background:var(--c-card);border-radius:16px;border:1px solid var(--c-card-border);border-left:4px solid var(--c-accent);box-shadow:0 8px 24px var(--c-card-shadow);padding:1.75rem 2rem;margin-top:16px;animation:slideUp .35s ease}
    .conversion-result-card .conv-title{font-size:1.05rem;font-weight:600;color:var(--c-text);margin:0 0 .75rem 0}
    .conversion-result-card .conv-original{font-size:.9rem;color:var(--c-text-muted);margin-bottom:.5rem}
    .conversion-result-card .conv-result{font-size:.95rem;margin:.75rem 0;color:var(--c-text)}
    .conversion-result-card .conv-list{list-style:none;padding:0;margin:.5rem 0}
    .conversion-result-card .conv-list li{display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:.5rem;padding:14px 0;border-bottom:1px solid var(--c-card-border)}
    .conversion-result-card .conv-list li:last-child{border-bottom:none}
    .conversion-result-card .conv-list li .conv-item-content{flex:1;min-width:0}
    .conversion-result-card .conv-item-code{font-size:1rem;font-weight:700;color:var(--c-primary);margin:0 0 4px 0}
    .conversion-result-card .conv-item-name{font-size:.9rem;color:var(--c-text-muted);margin:0 0 2px 0}
    .conversion-result-card .conv-item-context{font-size:.8rem;font-style:italic;color:var(--c-text-dim);margin:0}
    .conversion-result-card .conv-actions{margin-top:1rem;display:flex;flex-wrap:wrap;gap:.6rem}
    .conversion-result-card .btn-small{padding:.5rem 1rem;font-size:.85rem;border-radius:50px;border:1px solid var(--c-chip-border);cursor:pointer;background:var(--c-chip-bg);color:var(--c-chip-fg);font-weight:600;font-family:inherit;transition:all .2s}
    .conversion-result-card .btn-small:hover{background:var(--c-primary-soft);border-color:var(--c-primary)}
    .conversion-empty{background:var(--c-warn-bg);color:var(--c-warn-fg);border:1px solid var(--c-warn-border);padding:1rem;border-radius:12px;margin-top:16px;font-size:.9rem}
    .conversion-error{background:var(--c-err-bg);color:var(--c-err-fg);border:1px solid var(--c-err-border);padding:1rem;border-radius:12px;margin-top:16px;font-size:.9rem}
    .conversion-error .retry-btn{margin-top:.5rem}
    .copied-toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);background:var(--c-accent);color:#fff;padding:.65rem 1.25rem;border-radius:50px;font-size:.875rem;font-weight:600;z-index:100;opacity:0;transition:opacity .2s;box-shadow:0 4px 16px rgba(124,58,237,.4)}
    .copied-toast.show{opacity:1;animation:fadeToast 2s ease}
    @keyframes fadeToast{0%,20%{opacity:1}100%{opacity:0}}
    .search-by-name-section{background:var(--c-card);border:1px solid var(--c-card-border);border-radius:16px;padding:1.75rem 2rem;margin-bottom:1.75rem;box-shadow:0 4px 16px var(--c-card-shadow);transition:opacity .3s ease;overflow:hidden}
    html.dark .search-by-name-section{backdrop-filter:blur(16px)}
    .search-by-name-section h2{font-size:1.3rem;font-weight:700;color:var(--c-text);margin:0 0 .4rem 0}
    .search-by-name-section .subtitle{color:var(--c-text-muted);font-size:.9rem;margin-bottom:1.25rem}
    .search-input-container{position:relative;margin-bottom:1rem}
    #diagnosisNameInput{width:100%;padding:.9rem 44px .9rem 1.15rem;font-size:1rem;font-family:inherit;font-weight:500;border:1px solid var(--c-input-border);border-radius:12px;background:var(--c-input-bg);color:var(--c-input-fg);box-sizing:border-box;transition:all .25s}
    #diagnosisNameInput::placeholder{color:var(--c-text-dim)}
    #diagnosisNameInput:focus{outline:none;border-color:var(--c-primary);box-shadow:0 0 0 3px rgba(139,92,246,.15)}
    #clearSearchBtn{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:var(--c-pill-bg);border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;font-size:14px;color:var(--c-text-muted);line-height:1;transition:all .2s}
    #clearSearchBtn:hover{background:var(--c-primary-soft);color:var(--c-text)}
    .example-searches{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:1.25rem}
    .example-searches .label{color:var(--c-text-dim);font-size:.8rem;font-weight:500}
    .example-btn{background:var(--c-chip-bg);border:1px solid var(--c-chip-border);padding:.4rem .85rem;border-radius:50px;font-size:.8rem;color:var(--c-chip-fg);cursor:pointer;font-family:inherit;font-weight:500;transition:all .2s}
    .example-btn:hover{background:var(--c-primary-soft);border-color:var(--c-primary)}
    .search-results{max-height:500px;overflow-y:auto;margin-top:1.25rem}
    .search-results::-webkit-scrollbar{width:5px}
    .search-results::-webkit-scrollbar-track{background:transparent}
    .search-results::-webkit-scrollbar-thumb{background:var(--c-card-border);border-radius:3px}
    .diagnosis-result-item{background:var(--c-si-bg);border:1px solid var(--c-si-border);border-left:4px solid var(--c-accent);border-radius:12px;padding:1.1rem;margin-bottom:10px;cursor:pointer;transition:all .2s}
    .diagnosis-result-item:hover{border-color:var(--c-primary);transform:translateX(4px);box-shadow:0 4px 16px rgba(139,92,246,.12)}
    .diagnosis-result-code{font-size:1.05rem;font-weight:700;color:var(--c-primary);margin-bottom:6px;letter-spacing:.3px}
    .diagnosis-result-desc{font-size:.9rem;color:var(--c-text-muted);line-height:1.5;margin:0}
    .search-loading-state{text-align:center;padding:40px;color:var(--c-text-muted)}
    .search-loading-state .search-spinner{display:block;width:40px;height:40px;margin:0 auto 16px;border:3px solid var(--c-card-border);border-top-color:var(--c-primary);border-radius:50%;animation:spin .8s linear infinite}
    .search-no-results{text-align:center;padding:40px;color:var(--c-text-muted)}
    .search-no-results-icon{font-size:48px;margin-bottom:16px}
    .search-results-count{font-size:.85rem;font-weight:500;color:var(--c-text-dim);margin-bottom:12px}
    /* ---- Auto-Detect styling ---- */
    .radio-group label[for="r_auto"]{font-weight:600;color:var(--c-accent);border-color:rgba(124,58,237,.35)}
    .radio-group label[for="r_auto"]:hover{border-color:var(--c-accent);box-shadow:0 2px 10px rgba(124,58,237,.2);transform:translateY(-1px)}
    .radio-group input#r_auto:checked+label{background:linear-gradient(135deg,#7c3aed,#a855f7);color:#fff;border-color:transparent;box-shadow:0 0 20px rgba(124,58,237,.45)}
    .detect-progress{background:var(--c-card);border:1px solid var(--c-card-border);border-radius:16px;padding:1.5rem 1.75rem;margin:1rem 0;box-shadow:0 4px 16px var(--c-card-shadow);animation:slideUp .35s ease}
    html.dark .detect-progress{backdrop-filter:blur(12px)}
    .detect-progress h3{font-size:1.1rem;font-weight:700;color:var(--c-text);margin:0 0 1rem 0;display:flex;align-items:center;gap:.5rem}
    .detect-progress .detect-spinner{display:inline-block;width:1rem;height:1rem;border:2px solid rgba(139,92,246,.2);border-top-color:var(--c-primary);border-radius:50%;animation:spin .8s linear infinite}
    .detect-progress .system-row{display:flex;align-items:center;gap:.6rem;padding:.45rem 0;font-size:.9rem;color:var(--c-text-muted)}
    .detect-progress .system-row.checking{color:var(--c-primary);font-weight:600}
    .detect-progress .system-row.checking .sys-icon{display:inline-block;width:.85rem;height:.85rem;border:2px solid rgba(139,92,246,.2);border-top-color:var(--c-primary);border-radius:50%;animation:spin .8s linear infinite}
    .detect-progress .system-row.fail .sys-icon{color:#ef4444}
    .detect-progress .system-row.success .sys-icon{color:#22c55e;font-weight:700}
    .detect-progress .system-row.pending{opacity:.4}
    .detect-banner{background:linear-gradient(135deg,rgba(34,197,94,.1),rgba(16,185,129,.08));border:1px solid rgba(34,197,94,.25);border-radius:12px;padding:1rem 1.25rem;margin:0 0 .75rem 0;animation:slideUp .35s ease}
    html.dark .detect-banner{background:linear-gradient(135deg,rgba(34,197,94,.12),rgba(16,185,129,.1));border-color:rgba(34,197,94,.3)}
    .detect-banner .banner-title{font-size:1rem;font-weight:700;color:#16a34a;margin:0 0 .25rem 0;display:flex;align-items:center;gap:.4rem}
    html.dark .detect-banner .banner-title{color:#4ade80}
    .detect-banner .banner-sub{font-size:.8rem;color:var(--c-text-muted);margin:0}
    .detect-fail{background:var(--c-err-bg);border:1px solid var(--c-err-border);border-radius:16px;padding:1.5rem 1.75rem;margin:1rem 0;animation:slideUp .35s ease}
    .detect-fail h3{font-size:1.1rem;font-weight:700;color:var(--c-err-fg);margin:0 0 1rem 0}
    .detect-fail .system-row{display:flex;align-items:center;gap:.6rem;padding:.3rem 0;font-size:.9rem;color:var(--c-err-fg);opacity:.8}
    /* ---- Educational info card ---- */
    .edu-card{background:var(--c-card);border:1px solid var(--c-card-border);border-radius:16px;padding:1.5rem 1.75rem;margin:1rem 0 0 0;box-shadow:0 4px 16px var(--c-card-shadow);animation:slideUp .35s ease}
    html.dark .edu-card{backdrop-filter:blur(12px)}
    .edu-card-header{display:flex;align-items:center;gap:.75rem;margin-bottom:1.25rem;padding-bottom:1rem;border-bottom:1px solid var(--c-card-border)}
    .edu-card-icon{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0}
    .edu-card-header-text{flex:1;min-width:0}
    .edu-card-header-text h4{font-size:1.1rem;font-weight:700;color:var(--c-text);margin:0 0 .2rem 0}
    .edu-card-header-text p{font-size:.8rem;color:var(--c-text-dim);margin:0;font-weight:500;text-transform:uppercase;letter-spacing:.5px}
    .edu-card-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:1.25rem}
    .edu-card-stat{padding:.75rem 1rem;border-radius:10px;background:var(--c-primary-soft);border:1px solid var(--c-chip-border)}
    .edu-card-stat .edu-stat-label{font-size:.65rem;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--c-text-dim);margin:0 0 .3rem 0}
    .edu-card-stat .edu-stat-value{font-size:.875rem;font-weight:600;color:var(--c-text);margin:0}
    .edu-card-purpose{padding:1rem;border-radius:10px;background:var(--c-primary-soft);border:1px solid var(--c-chip-border);margin-bottom:1rem}
    .edu-card-purpose .edu-stat-label{font-size:.65rem;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--c-text-dim);margin:0 0 .4rem 0}
    .edu-card-purpose p{font-size:.875rem;color:var(--c-text-muted);margin:0;line-height:1.5}
    .edu-card-why{display:flex;align-items:flex-start;gap:.6rem;padding:1rem;border-radius:10px;background:linear-gradient(135deg,rgba(124,58,237,.08),rgba(236,72,153,.06));border:1px solid rgba(139,92,246,.15)}
    html.dark .edu-card-why{background:linear-gradient(135deg,rgba(124,58,237,.12),rgba(236,72,153,.08));border-color:rgba(139,92,246,.2)}
    .edu-card-why i{color:var(--c-primary);margin-top:2px;flex-shrink:0}
    .edu-card-why p{font-size:.875rem;color:var(--c-text);margin:0;line-height:1.5;font-style:italic}
    .edu-toggle{display:inline-flex;align-items:center;gap:.4rem;margin-top:1rem;padding:.5rem 1rem;border-radius:50px;background:var(--c-chip-bg);color:var(--c-chip-fg);border:1px solid var(--c-chip-border);cursor:pointer;font-size:.8rem;font-weight:600;font-family:inherit;transition:all .2s}
    .edu-toggle:hover{background:var(--c-primary-soft);border-color:var(--c-primary)}
    .edu-toggle i{font-size:.7rem;transition:transform .3s}
    .edu-toggle.open i{transform:rotate(180deg)}
    @media(max-width:640px){.edu-card-grid{grid-template-columns:1fr}.input-row{flex-direction:column}.input-row input[type="text"]{min-width:100%}.conversion-buttons{flex-direction:column}.conversion-buttons .chip{width:100%}.search-by-name-section{padding:1.25rem}}
  </style>
</head>
<body class="font-sans min-h-screen bg-white dark:bg-[#0B0A1A] text-gray-900 dark:text-gray-100 transition-colors duration-300">
  <div class="bg-gradient-orbs"><div class="orb"></div><div class="orb"></div><div class="orb"></div></div>
  <canvas id="bgCanvas"></canvas>

  <div class="relative z-10 max-w-[920px] mx-auto px-5 sm:px-8 py-6 pb-10">
    <header class="text-center pt-8 pb-8 mb-8 relative">
      <button id="themeToggle" type="button" class="absolute top-4 right-0 w-10 h-10 rounded-full flex items-center justify-center bg-gray-100 dark:bg-white/10 border border-gray-200 dark:border-white/10 text-gray-500 dark:text-purple-300 hover:bg-gray-200 dark:hover:bg-white/20 transition-all" aria-label="Toggle theme">
        <i class="fa-solid fa-moon dark:hidden text-sm"></i>
        <i class="fa-solid fa-sun hidden dark:inline text-sm"></i>
      </button>
      <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight mb-3 text-gradient">Medical Code Lookup</h1>
      <p class="text-sm sm:text-base text-gray-500 dark:text-purple-300/70 tracking-wide">ICD-10 ¬∑ SNOMED CT ¬∑ LOINC ¬∑ ATC ¬∑ RxCUI ¬∑ CPT ¬∑ HCPCS ¬∑ NDC</p>
      <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-20 h-0.5 bg-gradient-to-r from-transparent via-purple-500 to-transparent"></div>
    </header>

    <div class="mb-6">
      <label class="block text-xs font-semibold uppercase tracking-[0.15em] mb-3 text-gray-400 dark:text-purple-300/60">Code Type</label>
      <div class="radio-group" id="codeTypeChips" role="radiogroup" aria-label="Code type"></div>
      <div class="info-banner" id="codeTypeDescription" aria-live="polite"></div>
      <div id="eduCardContainer"></div>
    </div>

    <div class="mb-6">
      <label for="codeInput" class="block text-xs font-semibold uppercase tracking-[0.15em] mb-3 text-gray-400 dark:text-purple-300/60">Code</label>
      <div class="input-row">
        <input type="text" id="codeInput" placeholder="e.g. E11.9" autocomplete="off" aria-label="Code">
        <button type="button" class="btn" id="lookupBtn"><i class="fa-solid fa-magnifying-glass mr-2 text-sm"></i>Lookup</button>
      </div>
      <div class="examples">
        <span>Try:</span>
        <span id="exampleChips"></span>
      </div>
    </div>

    <div id="messageArea"></div>
    <div id="resultContainer" class="min-h-[2rem]"></div>

    <section id="diagnosisSearchSection" class="search-by-name-section" aria-label="Search by diagnosis or clinical term" style="display:none;">
      <h2>üîç Search by Diagnosis Name</h2>
      <p class="subtitle" id="searchHint">Search ICD-10 codes by typing a condition or symptom (e.g., diabetes, headache, chest pain)</p>
      <div class="search-input-container">
        <input type="text" id="diagnosisNameInput" placeholder="Enter diagnosis or symptom..." autocomplete="off" aria-label="Search ICD-10 diagnosis by name" role="searchbox" aria-describedby="searchHint">
        <button type="button" id="clearSearchBtn" aria-label="Clear search" style="display:none;">‚úï</button>
      </div>
      <div class="example-searches">
        <span class="label">Try:</span>
        <button type="button" class="example-btn" data-term="diabetes">diabetes</button>
        <button type="button" class="example-btn" data-term="headache">headache</button>
        <button type="button" class="example-btn" data-term="chest pain">chest pain</button>
        <button type="button" class="example-btn" data-term="hypertension">hypertension</button>
        <button type="button" class="example-btn" data-term="flu">flu</button>
        <button type="button" class="example-btn" data-term="fever">fever</button>
        <button type="button" class="example-btn" data-term="cough">cough</button>
        <button type="button" class="example-btn" data-term="asthma">asthma</button>
      </div>
      <div id="searchLoading" class="search-loading-state" style="display:none;" aria-live="polite">
        <div class="search-spinner"></div>
        <p>Searching diagnoses...</p>
      </div>
      <div id="searchResults" class="search-results" style="display:none;" role="listbox" aria-label="Search results"></div>
    </section>
    <div id="copiedToast" class="copied-toast" aria-live="polite" role="status">Copied!</div>

    <aside class="mt-10 p-6 rounded-2xl bg-white dark:bg-white/[0.06] border border-gray-200 dark:border-white/10 shadow-sm dark:shadow-none dark:backdrop-blur-xl">
      <h3 class="text-lg font-bold mb-2 text-gray-900 dark:text-white"><i class="fa-solid fa-circle-info text-purple-500 mr-2"></i>About</h3>
      <p class="text-sm text-gray-500 dark:text-purple-300/70 mb-5">Look up medical and drug codes and get their <strong class="text-purple-600 dark:text-purple-400">official display names</strong> from authoritative APIs.</p>
      <h3 class="text-sm font-bold mb-3 text-gray-900 dark:text-white uppercase tracking-wide"><i class="fa-solid fa-database text-purple-500 mr-2"></i>API Sources</h3>
      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 mb-5">
        <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-purple-50 dark:bg-purple-500/10 border border-purple-100 dark:border-purple-500/20"><span class="text-xs font-bold text-purple-700 dark:text-purple-300">ICD-10</span><span class="text-[10px] text-gray-400 dark:text-purple-300/50">NLM / WHO</span></div>
        <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-purple-50 dark:bg-purple-500/10 border border-purple-100 dark:border-purple-500/20"><span class="text-xs font-bold text-purple-700 dark:text-purple-300">SNOMED</span><span class="text-[10px] text-gray-400 dark:text-purple-300/50">Snowstorm</span></div>
        <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-purple-50 dark:bg-purple-500/10 border border-purple-100 dark:border-purple-500/20"><span class="text-xs font-bold text-purple-700 dark:text-purple-300">LOINC</span><span class="text-[10px] text-gray-400 dark:text-purple-300/50">NLM</span></div>
        <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-purple-50 dark:bg-purple-500/10 border border-purple-100 dark:border-purple-500/20"><span class="text-xs font-bold text-purple-700 dark:text-purple-300">ATC</span><span class="text-[10px] text-gray-400 dark:text-purple-300/50">RxNorm</span></div>
        <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-purple-50 dark:bg-purple-500/10 border border-purple-100 dark:border-purple-500/20"><span class="text-xs font-bold text-purple-700 dark:text-purple-300">RxCUI</span><span class="text-[10px] text-gray-400 dark:text-purple-300/50">RxNorm</span></div>
        <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-purple-50 dark:bg-purple-500/10 border border-purple-100 dark:border-purple-500/20"><span class="text-xs font-bold text-purple-700 dark:text-purple-300">CPT</span><span class="text-[10px] text-gray-400 dark:text-purple-300/50">AAPC</span></div>
        <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-purple-50 dark:bg-purple-500/10 border border-purple-100 dark:border-purple-500/20"><span class="text-xs font-bold text-purple-700 dark:text-purple-300">HCPCS</span><span class="text-[10px] text-gray-400 dark:text-purple-300/50">NLM / AAPC</span></div>
        <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-purple-50 dark:bg-purple-500/10 border border-purple-100 dark:border-purple-500/20"><span class="text-xs font-bold text-purple-700 dark:text-purple-300">NDC</span><span class="text-[10px] text-gray-400 dark:text-purple-300/50">RxNav</span></div>
      </div>
      <p id="historySection" style="display:none;" class="text-sm text-gray-500 dark:text-purple-300/60"><strong class="text-purple-600 dark:text-purple-400">Recent:</strong> <span id="historyList"></span></p>
    </aside>
  </div>

  <footer class="relative z-10 mt-8 py-6 text-center border-t border-gray-200 dark:border-white/10">
    <div class="text-sm font-semibold text-gray-400 dark:text-purple-300/50 mb-1">Medical Code Lookup Tool</div>
    <div class="text-xs text-gray-400 dark:text-purple-300/40">&copy; 2026 Netanel Greifner, MD, MHA</div>
  </footer>

<script>
    const CODE_TYPES = [
      { id: "auto", label: "\ud83d\udd0d Auto-Detect", description: "Don\u2019t know the code type? Enter any medical code and we\u2019ll identify it for you automatically." },
      { id: "icd", label: "ICD-10", description: "International Classification of Diseases, 10th revision. Used for diagnoses, billing, and statistics (ICD-10-CM)." },
      { id: "snomed", label: "SNOMED CT", description: "Comprehensive clinical terminology used for detailed electronic health records." },
      { id: "cpt", label: "CPT", description: "Current Procedural Terminology. Used for reporting medical procedures and services." },
      { id: "hcpcs", label: "HCPCS", description: "Healthcare Common Procedure Coding System. Used for supplies, equipment, and services (Level II)." },
      { id: "loinc", label: "LOINC", description: "Logical Observation Identifiers Names and Codes. Standard for lab results and clinical observations." },
      { id: "ndc", label: "NDC", description: "National Drug Code. Identifies specific drug products (packaging, manufacturer)." },
      { id: "rxcui", label: "RxCUI", description: "RxNorm Concept Unique Identifier. Standard for clinical drug ingredients and forms." },
      { id: "atc", label: "ATC", description: "Anatomical Therapeutic Chemical. Classifies drugs by organ system and therapeutic properties." }
    ];
    const CODE_TYPE_TO_API = { auto: "AUTO", icd: "ICD", snomed: "SNOMED", cpt: "CPT", hcpcs: "HCPCS", loinc: "LOINC", ndc: "NDC", rxcui: "RXCUI", atc: "ATC" };

    const CODE_SYSTEM_INFO = {
      ICD: {
        icon: "fa-solid fa-hospital",
        iconBg: "background:linear-gradient(135deg,#7c3aed,#a78bfa);color:#fff",
        fullName: "International Classification of Diseases, 10th Revision",
        shortLabel: "ICD-10-CM",
        maintainer: "World Health Organization (WHO)",
        maintainerNote: "US clinical modification maintained by CDC & CMS",
        established: "1990 (ICD-10); US adopted 2015",
        purpose: "A universal diagnostic coding system that translates every disease, disorder, injury, and health condition into a standardized alphanumeric code. It is the global language of medicine for epidemiology and billing.",
        useToday: "Required on virtually every medical claim, hospital record, and death certificate worldwide. It drives insurance reimbursement, public health surveillance, and clinical research.",
        whyMatters: "This is the code your doctor records when they make a diagnosis ‚Äî and what your insurance company sees to decide whether to cover your treatment."
      },
      SNOMED: {
        icon: "fa-solid fa-brain",
        iconBg: "background:linear-gradient(135deg,#0891b2,#06b6d4);color:#fff",
        fullName: "Systematized Nomenclature of Medicine ‚Äî Clinical Terms",
        shortLabel: "SNOMED CT",
        maintainer: "SNOMED International",
        maintainerNote: "Managed by a non-profit with 40+ member countries",
        established: "2002 (merged from SNOMED RT + UK Clinical Terms)",
        purpose: "The most comprehensive clinical terminology in the world, with over 350,000 concepts. It captures clinical detail far beyond what billing codes allow ‚Äî symptoms, findings, procedures, body structures, and more.",
        useToday: "The backbone of modern Electronic Health Records (EHRs). It enables clinical decision support, quality measurement, and interoperable health data exchange across systems and borders.",
        whyMatters: "When your doctor types clinical notes into their computer, SNOMED CT is often the hidden language that makes those notes structured, searchable, and shareable between hospitals."
      },
      CPT: {
        icon: "fa-solid fa-user-doctor",
        iconBg: "background:linear-gradient(135deg,#059669,#34d399);color:#fff",
        fullName: "Current Procedural Terminology",
        shortLabel: "CPT",
        maintainer: "American Medical Association (AMA)",
        maintainerNote: "Updated annually; proprietary ‚Äî requires a license to use",
        established: "1966",
        purpose: "A standardized system of 5-digit codes that describe every medical, surgical, and diagnostic service a physician can perform. It is the universal language for communicating 'what was done' to a patient.",
        useToday: "Required on virtually every outpatient medical claim in the United States. It directly determines how much physicians and hospitals are paid by insurance companies.",
        whyMatters: "Every time you visit a doctor, the services you receive are translated into CPT codes ‚Äî these codes determine exactly how much your provider gets reimbursed and what shows up on your bill."
      },
      HCPCS: {
        icon: "fa-solid fa-wheelchair",
        iconBg: "background:linear-gradient(135deg,#d97706,#fbbf24);color:#fff",
        fullName: "Healthcare Common Procedure Coding System",
        shortLabel: "HCPCS Level II",
        maintainer: "Centers for Medicare & Medicaid Services (CMS)",
        maintainerNote: "Supplements CPT; updated quarterly",
        established: "1978",
        purpose: "Extends CPT to cover items and services not included in physician procedures ‚Äî such as ambulance rides, durable medical equipment (wheelchairs, CPAP machines), prosthetics, orthotics, and supplies.",
        useToday: "Required for Medicare, Medicaid, and most insurance billing for non-physician services and medical supplies. Essential for home health, DME suppliers, and outpatient facilities.",
        whyMatters: "If you've ever gotten a wheelchair, hearing aid, insulin pump, or home oxygen ‚Äî HCPCS is the code system that made it possible for insurance to cover it."
      },
      LOINC: {
        icon: "fa-solid fa-flask-vial",
        iconBg: "background:linear-gradient(135deg,#dc2626,#f87171);color:#fff",
        fullName: "Logical Observation Identifiers Names and Codes",
        shortLabel: "LOINC",
        maintainer: "Regenstrief Institute",
        maintainerNote: "Free and open; updated semi-annually",
        established: "1994",
        purpose: "A universal standard for identifying lab tests and clinical observations. Instead of every hospital having its own name for 'blood glucose,' LOINC gives it one universal code (2345-7) that works everywhere.",
        useToday: "Required by US federal regulations for electronic lab reporting. Used by 98% of large US hospitals and adopted in 180+ countries for lab interoperability.",
        whyMatters: "When your blood test results transfer seamlessly from the lab to your doctor's screen to your patient portal ‚Äî LOINC is the reason those results are understood correctly everywhere."
      },
      NDC: {
        icon: "fa-solid fa-barcode",
        iconBg: "background:linear-gradient(135deg,#4f46e5,#818cf8);color:#fff",
        fullName: "National Drug Code",
        shortLabel: "NDC",
        maintainer: "U.S. Food and Drug Administration (FDA)",
        maintainerNote: "Maintained via the FDA Drug Registration & Listing System",
        established: "1972",
        purpose: "A unique 10- or 11-digit identifier assigned to every drug product sold in the US. It encodes three pieces of information: the manufacturer (labeler), the specific product (drug, strength, form), and the package size.",
        useToday: "Printed on every drug package sold in the US. Used by pharmacies for dispensing, by hospitals for inventory tracking, and by insurers for formulary management and claims processing.",
        whyMatters: "The barcode your pharmacist scans when filling your prescription is an NDC ‚Äî it ensures you get exactly the right drug, strength, and package every time."
      },
      RXCUI: {
        icon: "fa-solid fa-pills",
        iconBg: "background:linear-gradient(135deg,#9333ea,#c084fc);color:#fff",
        fullName: "RxNorm Concept Unique Identifier",
        shortLabel: "RxCUI",
        maintainer: "National Library of Medicine (NLM)",
        maintainerNote: "Part of RxNorm; updated monthly; free to use",
        established: "2004",
        purpose: "A normalized identifier that links the many names for the same drug. Whether a system calls it 'acetaminophen,' 'Tylenol,' or 'APAP 500mg tablet,' RxCUI maps them all to one concept so systems can communicate.",
        useToday: "The standard drug vocabulary for US EHR systems, e-prescribing, drug interaction databases, and clinical decision support. It bridges the gap between brand names, generics, and clinical drug formulations.",
        whyMatters: "When your doctor's system warns about a dangerous drug interaction or your pharmacy substitutes a generic ‚Äî RxNorm and RxCUI are working behind the scenes to keep you safe."
      },
      ATC: {
        icon: "fa-solid fa-capsules",
        iconBg: "background:linear-gradient(135deg,#0284c7,#38bdf8);color:#fff",
        fullName: "Anatomical Therapeutic Chemical Classification",
        shortLabel: "ATC",
        maintainer: "WHO Collaborating Centre for Drug Statistics (Norway)",
        maintainerNote: "Updated annually; used alongside DDD (Defined Daily Dose)",
        established: "1976",
        purpose: "A hierarchical 5-level system that classifies every drug by where it acts in the body and what it does therapeutically. Each level narrows from organ system ‚Üí therapeutic group ‚Üí pharmacological group ‚Üí chemical group ‚Üí specific substance.",
        useToday: "The international gold standard for drug utilization research and pharmacoepidemiology. Used by governments and WHO to compare drug consumption across countries and track prescribing trends.",
        whyMatters: "When researchers compare how different countries prescribe antibiotics, or when a health system analyzes its drug spending patterns ‚Äî ATC is the classification that makes those comparisons possible."
      }
    };

    const TTY_LABELS = {
      BN: "Brand Name", IN: "Generic Name", SCD: "Clinical Drug",
      SBD: "Branded Drug", GPCK: "Clinical Pack", BPCK: "Branded Pack",
      PIN: "Precise Ingredient", MIN: "Multiple Ingredient",
      SY: "Synonym", TMSY: "Tall Man Synonym", PSN: "Prescribable Name",
      SCDC: "Clinical Drug Component", SBDC: "Branded Drug Component"
    };
    const EXAMPLES = {
      AUTO: ["E11.9", "73211009", "99213", "J0171", "2160-0"],
      ICD: ["E11.9", "I10", "J18.9"],
      SNOMED: ["38341003", "73211009", "233604007"],
      LOINC: ["2345-7", "6690-2", "2160-0"],
      ATC: ["N02BE01", "C09AA01", "A02BC01"],
      RXCUI: ["161", "8001", "1191"],
      CPT: ["99213", "97110", "99397"],
      HCPCS: ["A4244", "J0135", "E0118"],
      NDC: ["00002-3105-02", "00003-2188-51", "00069-5420-66"]
    };
    const CORS_PROXY = "https://corsproxy.io/?";
    const CORS_ALLORIGINS_GET = "https://api.allorigins.win/get?url=";
    const CORS_ALLORIGINS_RAW = "https://api.allorigins.win/raw?url=";
    const PROXY_OPTS = { referrerPolicy: "no-referrer", mode: "cors" };
    const RXNAV_REST = "https://rxnav.nlm.nih.gov/REST";
    const RXNAV_NDC_STATUS = "https://rxnav.nlm.nih.gov/REST/ndcstatus.json";
    const USER_AGENT = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
    const NLM_ICD = "https://clinicaltables.nlm.nih.gov/api/icd10cm/v3/search";
    const NLM_HCPCS = "https://clinicaltables.nlm.nih.gov/api/hcpcs/v3/search";
    const LOINC_URL = "https://clinicaltables.nlm.nih.gov/api/loinc_items/v3/search";
    const WHO_BASE = "https://id.who.int/icd/release/11/2024-01";
    const SNOMED_BASES = [
      "https://snowstorm.snomedtools.org/snowstorm/snomed-ct",
      "https://snowstorm-training.snomedtools.org/snowstorm/snomed-ct"
    ];

    let history = [];
    let lastDrugResult = null;
    try {
      const s = localStorage.getItem("codeLookupHistory");
      if (s) history = JSON.parse(s);
    } catch (_) {}

    function saveHistory() {
      try { localStorage.setItem("codeLookupHistory", JSON.stringify(history.slice(-20))); } catch (_) {}
    }

    function addToHistory(codeType, code, displayName) {
      history.push({ codeType, code, preview: (displayName || "").slice(0, 40) });
      history = history.slice(-20);
      saveHistory();
      renderHistory();
    }

    function renderHistory() {
      const el = document.getElementById("historyList");
      const section = document.getElementById("historySection");
      if (!el || history.length === 0) {
        if (section) section.style.display = "none";
        return;
      }
      section.style.display = "block";
      el.innerHTML = history.slice(-5).reverse().map(h =>
        `<span style="margin-right:0.5rem;">${h.codeType} <strong>${h.code}</strong></span>`
      ).join("");
    }

    function showMessage(text, type) {
      const area = document.getElementById("messageArea");
      area.innerHTML = `<div class="message ${type}">${text}</div>`;
    }
    function clearMessage() {
      document.getElementById("messageArea").innerHTML = "";
    }

    function escapeHtml(s) {
      if (!s) return "";
      return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    function buildConversionSection(codeType, displayName, codeValue) {
      const buttons = [];
      if (codeType === "RXCUI") {
        buttons.push({ target: "ATC", label: "View ATC Code" });
      } else if (codeType === "NDC") {
        buttons.push({ target: "RXCUI", label: "View RxCUI" });
      } else if (codeType === "ATC") {
        buttons.push({ target: "RXCUI", label: "View RxCUI Codes" });
      }
      if (buttons.length === 0) return "";
      const btnHtml = buttons.map(b => `<button type="button" class="chip conversion-btn" data-conversion-target="${escapeHtml(b.target)}">üîÑ ${escapeHtml(b.label)}</button>`).join("");
      return `
        <div class="conversion-section">
          <hr class="conversion-divider">
          <p class="conversion-heading">Convert to</p>
          <div class="conversion-buttons">${btnHtml}</div>
          <div id="conversionResult"></div>
        </div>`;
    }

    const ATC_LEVEL_LABELS = { 1: "Level 1 ‚Äì Anatomical main group", 3: "Level 2 ‚Äì Therapeutic subgroup", 4: "Level 3 ‚Äì Pharmacological subgroup", 5: "Level 4 ‚Äì Chemical subgroup", 7: "Level 5 ‚Äì Chemical substance" };

    function buildEduCard(codeType) {
      const info = CODE_SYSTEM_INFO[codeType];
      if (!info) return "";
      return `
        <button type="button" class="edu-toggle" id="eduToggleBtn">
          <i class="fa-solid fa-graduation-cap"></i> Learn about ${escapeHtml(info.shortLabel)}
          <i class="fa-solid fa-chevron-down"></i>
        </button>
        <div id="eduCardContent" style="display:none;">
          <div class="edu-card">
            <div class="edu-card-header">
              <div class="edu-card-icon" style="${info.iconBg}"><i class="${info.icon}"></i></div>
              <div class="edu-card-header-text">
                <h4>${escapeHtml(info.fullName)}</h4>
                <p>${escapeHtml(info.shortLabel)}</p>
              </div>
            </div>
            <div class="edu-card-grid">
              <div class="edu-card-stat">
                <p class="edu-stat-label"><i class="fa-solid fa-building-columns" style="margin-right:4px"></i>Maintained by</p>
                <p class="edu-stat-value">${escapeHtml(info.maintainer)}</p>
              </div>
              <div class="edu-card-stat">
                <p class="edu-stat-label"><i class="fa-solid fa-calendar" style="margin-right:4px"></i>Established</p>
                <p class="edu-stat-value">${escapeHtml(info.established)}</p>
              </div>
            </div>
            <div class="edu-card-purpose">
              <p class="edu-stat-label"><i class="fa-solid fa-bullseye" style="margin-right:4px"></i>Purpose</p>
              <p>${escapeHtml(info.purpose)}</p>
            </div>
            <div class="edu-card-purpose" style="margin-bottom:1rem">
              <p class="edu-stat-label"><i class="fa-solid fa-chart-line" style="margin-right:4px"></i>Use today</p>
              <p>${escapeHtml(info.useToday)}</p>
            </div>
            <div class="edu-card-why">
              <i class="fa-solid fa-lightbulb"></i>
              <p>${escapeHtml(info.whyMatters)}</p>
            </div>
          </div>
        </div>`;
    }

    function bindEduToggle() {
      const btn = document.getElementById("eduToggleBtn");
      const content = document.getElementById("eduCardContent");
      if (!btn || !content) return;
      btn.addEventListener("click", function() {
        const open = content.style.display !== "none";
        content.style.display = open ? "none" : "block";
        btn.classList.toggle("open", !open);
      });
    }

    function updateEduCardForType(overrideKey) {
      let codeType;
      if (overrideKey) {
        codeType = overrideKey.toUpperCase();
      } else {
        const selected = document.querySelector('input[name="codeType"]:checked');
        const val = selected ? selected.value : CODE_TYPES[0].id;
        if (val === "auto") {
          // Show nothing for auto until detection happens
          const container = document.getElementById("eduCardContainer");
          if (container) container.innerHTML = "";
          return;
        }
        codeType = val.toUpperCase();
      }
      const container = document.getElementById("eduCardContainer");
      if (!container) return;
      container.innerHTML = buildEduCard(codeType);
      bindEduToggle();
    }

    function renderResult(data, codeType, code) {
      const name = escapeHtml(data.display_name || "‚Äî");
      const codeLabel = escapeHtml(data.code_label || "Code");
      const codeVal = escapeHtml(data.code_value || "‚Äî");
      const source = escapeHtml(data.source || "‚Äî");
      const category = data.category ? escapeHtml(data.category) : "";
      const rxcui = data.rxcui ? escapeHtml(data.rxcui) : "";
      const atcClassName = data.atc_class_name ? escapeHtml(data.atc_class_name) : "";
      const atcClassBlock = atcClassName ? `<p class="source-label">ATC Classification</p><p class="source-value">${atcClassName}</p>` : "";
      const tty = data.term_type;
      const ttyLabel = tty ? (TTY_LABELS[tty.toUpperCase()] || tty) : null;
      const ttyBadge = ttyLabel ? `<span class="badge badge-teal">${escapeHtml(ttyLabel)}</span>` : "";
      const atcLevelLabel = codeType === "ATC" && data.code_value ? (ATC_LEVEL_LABELS[data.code_value.length] || null) : null;
      const atcLevelBadge = atcLevelLabel ? `<span class="badge badge-teal">${escapeHtml(atcLevelLabel)}</span>` : "";
      const categoryBlock = category ? `<p class="source-label">Category</p><p class="source-value">${category}</p>` : "";
      const rxcuiBlock = rxcui ? `<p class="source-label">RxCUI</p><p class="source-value">${rxcui}</p>` : "";
      const isDrug = codeType === "RXCUI" || codeType === "NDC" || codeType === "ATC";
      if (isDrug) lastDrugResult = { data, codeType, code: code || data.code_value };
      else lastDrugResult = null;
      const conversionHtml = isDrug ? buildConversionSection(codeType, data.display_name, codeVal) : "";
      document.getElementById("resultContainer").innerHTML = `
        <div class="result-card">
          <p class="display-name">${name}</p>
          <div class="badges">
            <span class="badge">${codeLabel}: ${codeVal}</span>${ttyBadge}${atcLevelBadge}
          </div>
          ${categoryBlock}
          ${rxcuiBlock}
          ${atcClassBlock}
          <p class="source-label">Source</p>
          <p class="source-value">${source}</p>
        </div>${conversionHtml}`;
      if (isDrug) bindConversionButtons();
    }

    function setLoading(loading) {
      const btn = document.getElementById("lookupBtn");
      const selected = document.querySelector('input[name="codeType"]:checked');
      const isAuto = selected && selected.value === "auto";
      if (loading) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> ' + (isAuto ? 'Detecting...' : 'Looking up...');
      } else {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-magnifying-glass mr-2 text-sm"></i>' + (isAuto ? 'Detect & Lookup' : 'Lookup');
      }
    }

    const LOOKUP_TIMEOUT_MS = 8000;
    const AUTO_DETECT_TIMEOUT_MS = 3000;
    let _autoDetectSignal = null; // AbortSignal active during auto-detect calls only
    function lookupTimeout(ms) {
      return new Promise((_, reject) => setTimeout(() => reject(new Error("LOOKUP_TIMEOUT")), ms));
    }

    /** Fetch with timeout to avoid hanging. Returns null on timeout or error. */
    async function fetchWithTimeout(url, ms, opts = {}) {
      if (_autoDetectSignal && _autoDetectSignal.aborted) return null;
      const ctrl = new AbortController();
      const id = setTimeout(() => ctrl.abort(), ms);
      if (_autoDetectSignal) {
        _autoDetectSignal.addEventListener('abort', () => ctrl.abort(), { once: true });
      }
      try {
        const res = await fetch(url, { ...opts, signal: ctrl.signal });
        clearTimeout(id);
        return res;
      } catch (_) {
        clearTimeout(id);
        return null;
      }
    }

    async function fetchJson(url, opts = {}) {
      try {
        if (_autoDetectSignal && _autoDetectSignal.aborted) return null;
        const signal = opts.signal || _autoDetectSignal || undefined;
        const res = await fetch(url, { ...opts, signal, headers: { Accept: "application/json", ...(opts.headers || {}) } });
        if (!res.ok) return null;
        return await res.json();
      } catch (_) {
        return null;
      }
    }

    /** Fetch JSON with timeout. Returns null on timeout or error. */
    async function fetchJsonWithTimeout(url, ms) {
      const res = await fetchWithTimeout(url, ms, { headers: { Accept: "application/json" } });
      if (!res || !res.ok) return null;
      try {
        return await res.json();
      } catch (_) {
        return null;
      }
    }

    async function fetchJsonWithProxy(url) {
      if (_autoDetectSignal && _autoDetectSignal.aborted) return null;
      let data = await fetchJson(url);
      if (data !== null) return data;
      if (_autoDetectSignal && _autoDetectSignal.aborted) return null;
      const encoded = encodeURIComponent(url);
      const sig = _autoDetectSignal || undefined;
      try {
        const res = await fetch(CORS_ALLORIGINS_GET + encoded, { ...PROXY_OPTS, headers: { Accept: "application/json" }, signal: sig });
        if (res.ok) {
          const wrap = await res.json();
          if (wrap && wrap.contents != null) {
            const parsed = typeof wrap.contents === "string" ? (function() { try { return JSON.parse(wrap.contents); } catch (_) { return null; } })() : wrap.contents;
            if (parsed != null) return parsed;
          }
        }
      } catch (_) {}
      if (_autoDetectSignal && _autoDetectSignal.aborted) return null;
      try {
        const res = await fetch(CORS_PROXY + encoded, { ...PROXY_OPTS, headers: { Accept: "application/json" }, signal: sig });
        if (!res.ok) return null;
        return await res.json();
      } catch (_) {
        return null;
      }
    }

    async function fetchJsonExternal(url, opts = {}) {
      let data = await fetchJson(url, opts);
      if (data != null) return data;
      return await fetchJsonWithProxy(url);
    }

    const PROXY_TIMEOUT_MS = 3000;

    async function fetchHtmlWithProxy(url) {
      const headers = { "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8", "User-Agent": USER_AGENT };
      const encoded = encodeURIComponent(url);
      try {
        const res = await fetchWithTimeout(CORS_ALLORIGINS_RAW + encoded, PROXY_TIMEOUT_MS, { ...PROXY_OPTS, headers });
        if (res && res.ok) {
          const html = await res.text();
          if (html && html.length > 200) return html;
        }
      } catch (_) {}
      try {
        const res = await fetchWithTimeout(CORS_ALLORIGINS_GET + encoded, PROXY_TIMEOUT_MS, { ...PROXY_OPTS, headers });
        if (res && res.ok) {
          const wrap = await res.json();
          const html = (wrap && wrap.contents != null) ? (typeof wrap.contents === "string" ? wrap.contents : "") : "";
          if (html.length > 200) return html;
        }
      } catch (_) {}
      try {
        const res = await fetchWithTimeout(CORS_PROXY + encoded, PROXY_TIMEOUT_MS, { ...PROXY_OPTS, headers });
        if (res && res.ok) {
          const html = await res.text();
          if (html && html.length > 200) return html;
        }
      } catch (_) {}
      return null;
    }

    /** Fetch HTML via all CORS proxies in parallel ‚Äî return first success. Much faster than sequential. */
    async function fetchHtmlWithProxyRace(url) {
      const encoded = encodeURIComponent(url);
      const headers = {
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "User-Agent": USER_AGENT
      };

      const attempts = [
        (async () => {
          const res = await fetchWithTimeout(
            CORS_ALLORIGINS_RAW + encoded, PROXY_TIMEOUT_MS, { ...PROXY_OPTS, headers }
          );
          if (!res || !res.ok) throw new Error("fail");
          const html = await res.text();
          if (!html || html.length < 200) throw new Error("empty");
          return html;
        })(),
        (async () => {
          const res = await fetchWithTimeout(
            CORS_ALLORIGINS_GET + encoded, PROXY_TIMEOUT_MS, { ...PROXY_OPTS, headers }
          );
          if (!res || !res.ok) throw new Error("fail");
          const wrap = await res.json();
          const html = (wrap && wrap.contents && typeof wrap.contents === "string") ? wrap.contents : "";
          if (html.length < 200) throw new Error("empty");
          return html;
        })(),
        (async () => {
          const res = await fetchWithTimeout(
            CORS_PROXY + encoded, PROXY_TIMEOUT_MS, { ...PROXY_OPTS, headers }
          );
          if (!res || !res.ok) throw new Error("fail");
          const html = await res.text();
          if (!html || html.length < 200) throw new Error("empty");
          return html;
        })()
      ];

      try {
        return await Promise.any(attempts);
      } catch (_) {
        return null;
      }
    }

    const SNOMED_REQUEST_MS = 2000;

    async function fetchSnomed(code) {
      code = code.trim();
      if (!code || !/^\d+$/.test(code)) return null;
      const path = `/browser/MAIN/concepts/${code}`;
      const parseConcept = (data) => {
        if (!data) return null;
        const pt = data.pt || {};
        const fsn = data.fsn || {};
        const term = (pt.term || pt.value || fsn.term || fsn.value || "").trim();
        return { display_name: term || "‚Äî", code_label: "SNOMED CT Code", code_value: code, source: "Snowstorm SNOMED CT API", term_type: null };
      };
      for (const base of SNOMED_BASES) {
        const data = await fetchJsonWithTimeout(base + path, SNOMED_REQUEST_MS);
        const result = parseConcept(data);
        if (result) return result;
      }
      for (const base of SNOMED_BASES) {
        const data = await fetchJsonWithProxy(base + path);
        const result = parseConcept(data);
        if (result) return result;
      }
      return null;
    }

    async function fetchLoinc(code) {
      code = code.trim().toUpperCase();
      if (!code) return null;
      try {
        const url = `${LOINC_URL}?terms=${encodeURIComponent(code)}&count=100`;
        const data = await fetchJsonExternal(url);
        if (!Array.isArray(data) || data.length < 4) return null;
        const codesList = data[1] || [];
        const namesList = data[3] || [];
        if (!codesList.length) return null;
        const codeClean = code.replace(/\s/g, "").replace(/-/g, "");
        for (let i = 0; i < codesList.length; i++) {
          const c = String(codesList[i]).trim().toUpperCase();
          const cClean = c.replace(/\s/g, "").replace(/-/g, "");
          if (c === code || cClean === codeClean) {
            let name = "";
            if (i < namesList.length && namesList[i]) {
              const part = namesList[i];
              name = Array.isArray(part) && part[0] != null ? String(part[0]).trim() : String(part).trim();
            }
            return { display_name: name || "‚Äî", code_label: "LOINC Code", code_value: c, source: "NLM Clinical Tables API (LOINC)", term_type: null };
          }
        }
        const c0 = String(codesList[0]).trim().toUpperCase();
        if (code.includes(c0) || c0.startsWith(code) || codeClean.includes(c0.replace(/-/g, ""))) {
          const part = namesList[0];
          const name = Array.isArray(part) && part[0] != null ? String(part[0]).trim() : (part ? String(part).trim() : "‚Äî");
          return { display_name: name || "‚Äî", code_label: "LOINC Code", code_value: c0, source: "NLM Clinical Tables API (LOINC)", term_type: null };
        }
      } catch (_) {}
      return null;
    }

    async function fetchRxcui(code) {
      code = code.trim();
      if (!code || !/^\d+$/.test(code)) return null;
      try {
        const data = await fetchJsonExternal(`https://rxnav.nlm.nih.gov/REST/rxcui/${code}/properties.json`);
        if (!data) return null;
        const props = data.properties || data;
        const name = props.name || props.synonym || "";
        const tty = (props.tty || "").trim();
        if (!name && !tty) return null;
        return { display_name: name || "‚Äî", code_label: "RxCUI", code_value: code, source: "NLM RxNorm API (rxnav.nlm.nih.gov)", term_type: tty || null };
      } catch (_) {}
      return null;
    }

    async function fetchAtc(code) {
      code = code.trim().toUpperCase().replace(/\s/g, "");
      if (!code) return null;
      try {
        const data = await fetchJsonExternal(`https://rxnav.nlm.nih.gov/REST/rxcui.json?idtype=ATC&id=${encodeURIComponent(code)}`);
        if (!data) return null;
        const idGroup = data.idGroup || {};
        let rxcuiList = idGroup.rxnormId || [];
        if (typeof rxcuiList === "string") rxcuiList = [rxcuiList];
        if (!rxcuiList.length) return null;
        const first = rxcuiList[0];
        const [pData, atcClassName] = await Promise.all([
          fetchJsonExternal(`https://rxnav.nlm.nih.gov/REST/rxcui/${first}/properties.json`),
          fetchAtcName(code).catch(() => null)
        ]);
        let name = `(RxCUI ${first})`;
        if (pData) {
          const p = pData.properties || pData;
          name = p.name || p.synonym || name;
        }
        let atcClassDisplay = atcClassName || undefined;
        if (code.length === 7 && atcClassDisplay === name) {
          const level4Name = await fetchRxclassAtcDescription(code.slice(0, 5)).catch(() => null);
          if (level4Name) atcClassDisplay = level4Name;
        }
        let source = "NLM RxNorm API (ATC mapping)";
        if (rxcuiList.length > 1) source += ` ‚Äî maps to ${rxcuiList.length} RxNorm concept(s); showing first.`;
        return {
          display_name: name,
          code_label: "ATC Code",
          code_value: code,
          source,
          term_type: null,
          atc_class_name: atcClassDisplay
        };
      } catch (_) {}
      return null;
    }

    async function fetchIcdNlm(code) {
      try {
        const url = `${NLM_ICD}?terms=${encodeURIComponent(code)}&count=100`;
        const data = await fetchJsonExternal(url);
        if (!Array.isArray(data) || data.length < 4) return null;
        const pairs = data[3] || [];
        if (!pairs.length) return null;
        const codeUpper = code.toUpperCase();
        const codeNoDot = codeUpper.replace(/\./g, "");
        for (const pair of pairs) {
          if (!Array.isArray(pair) || pair.length < 2) continue;
          const cPart = String(pair[0]).trim();
          const nPart = String(pair[1]).trim();
          if (cPart.toUpperCase() === codeUpper || cPart.toUpperCase().replace(/\./g, "") === codeNoDot)
            return { display_name: nPart, code_label: "ICD-10 Code", code_value: cPart, source: "NLM Clinical Tables API (ICD-10-CM)", term_type: null };
        }
        const cPart = String(pairs[0][0]).trim();
        const nPart = String(pairs[0][1]).trim();
        const cPartNoDot = cPart.toUpperCase().replace(/\./g, "");
        const codePre = codeNoDot.slice(0, 3);
        const cPre = cPartNoDot.slice(0, 3);
        if (cPartNoDot.indexOf(codePre) !== -1 || codeNoDot.indexOf(cPre) !== -1)
          return { display_name: nPart, code_label: "ICD-10 Code", code_value: cPart, source: "NLM Clinical Tables API (ICD-10-CM)", term_type: null };
      } catch (_) {}
      return null;
    }

    async function fetchIcdWho(code) {
      const headers = { "Accept": "application/json", "Accept-Language": "en", "API-Version": "v2" };
      for (const path of [`/mms/${code}`, `/mms/foundation/${code}`]) {
        try {
          const data = await fetchJsonExternal(WHO_BASE + path, { headers });
          if (!data) continue;
          let name = data.title;
          if (typeof name === "object" && name && name["@value"]) name = name["@value"];
          if (!name && data.fullySpecifiedName) {
            const fsn = data.fullySpecifiedName;
            name = typeof fsn === "object" && fsn && fsn["@value"] ? fsn["@value"] : (fsn ? String(fsn) : "‚Äî");
          }
          return { display_name: name || "‚Äî", code_label: "ICD-10 Code", code_value: code, source: "WHO ICD API", term_type: null };
        } catch (_) {}
      }
      return null;
    }

    async function fetchIcd(code) {
      code = code.toUpperCase().replace(/\s/g, "").trim();
      const nlm = await fetchIcdNlm(code);
      if (nlm) return nlm;
      return await fetchIcdWho(code);
    }

    /** Clean CPT description: remove "CPT Code 99397", "Codify by AAPC", and other metadata. */
    function cleanCptDescription(text, code) {
      if (!text || !text.trim()) return "";
      let s = text.trim();
      // Remove prefix: "CPT¬Æ Code 99397 - " or "CPT ¬Æ 99397, " or "CPT Code 99397 - "
      s = s.replace(/^CPT\s*¬Æ?\s*Code\s*\d+\s*[-,:\s]+\s*/i, "");
      s = s.replace(/^CPT\s*¬Æ\s*\d+\s*,\s*Under\s+/i, "");
      // Remove suffix: " - Codify by AAPC" or ", Codify by AAPC"
      s = s.replace(/\s*[-,]\s*Codify\s+by\s+AAPC\.?\s*$/i, "");
      s = s.replace(/\s*-\s*Codify\s+by\s+AAPC\.?\s*$/i, "");
      // Remove any remaining " - Codify..." at end
      s = s.replace(/\s*-\s*[Cc]odify[^.]*\.?\s*$/i, "");
      return s.trim();
    }

    async function fetchCpt(code) {
      code = code.trim().replace(/\s/g, "");
      if (!code || !/^\d{4,5}$/.test(code)) return null;
      const url = `https://www.aapc.com/codes/cpt-codes/${code}`;
      try {
        const html = await fetchHtmlWithProxyRace(url);
        if (!html) return null;
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        const titleEl = doc.querySelector("title");
        const title = titleEl ? titleEl.textContent.trim() : "";
        let description = "";
        let category = "";
        // Prefer title for clean structure: "CPT¬Æ Code 99397 - Preventive Medicine Services, Established Patient - Codify by AAPC"
        if (title && title.includes(" - ")) {
          const parts = title.split(" - ").map(p => p.trim()).filter(Boolean);
          const codifyLast = parts.length > 0 && /Codify\s+by\s+AAPC/i.test(parts[parts.length - 1]);
          const firstIsCode = parts.length > 0 && /^CPT\s*¬Æ?\s*Code\s*\d+/i.test(parts[0]);
          if (codifyLast && firstIsCode && parts.length >= 2) {
            description = parts.slice(1, parts.length - 1).join(" - ");
            if (parts.length >= 3) category = parts[1];
          } else if (parts.length >= 2) {
            description = parts[1];
            category = parts[1];
          }
        }
        if (title && /Under\s+/i.test(title) && !category) {
          const underMatch = title.match(/Under\s+(.+?)(?:\s*-\s*|$)/i);
          if (underMatch) category = underMatch[1].trim();
        }
        if (!description) {
          const metaDesc = doc.querySelector('meta[name="description"]') || doc.querySelector('meta[property="og:description"]');
          if (metaDesc && metaDesc.getAttribute("content")) description = metaDesc.getAttribute("content").trim();
        }
        if (!description) {
          const p = doc.querySelector("p");
          if (p && p.textContent.trim().length > 30) description = p.textContent.trim().slice(0, 500);
        }
        description = cleanCptDescription(description, code);
        if (!description && category) description = category;
        if (!description) description = "See AAPC.com for full details.";
        return {
          display_name: description,
          code_label: "CPT Code",
          code_value: code,
          source: "AAPC (aapc.com)",
          term_type: null,
          category: category ? cleanCptDescription(category, code) || category : null
        };
      } catch (_) {
        return null;
      }
    }

    /** Clean HCPCS description: remove "HCPCS Code A4244", "Codify by AAPC", code prefix/suffix. Same logic as CPT. */
    function cleanHcpcsDescription(text, code) {
      if (!text || !text.trim()) return "";
      let s = text.trim();
      const codeUpper = (code || "").toUpperCase();
      s = s.replace(/^HCPCS\s*Code\s*for\s+/i, "");
      s = s.replace(new RegExp(`^HCPCS\\s*Code\\s*${codeUpper}\\s*[-,:\\s]+\\s*`, "i"), "");
      s = s.replace(/^HCPCS\s*Code\s*[A-Z]\d{4}\s*[-,:\s]+\s*/i, "");
      s = s.replace(new RegExp(`^${codeUpper}\\s*[-‚Äì‚Äî:]\\s*`, "i"), "");
      s = s.replace(new RegExp(`\\s+${codeUpper}\\s*$`, "i"), "");
      s = s.replace(/\s*[-,]\s*HCPCS\s+Codes?\s*$/i, "");
      s = s.replace(/\s*[-,]\s*Codify\s+by\s+AAPC\.?\s*$/i, "");
      s = s.replace(/\s*-\s*[Cc]odify[^.]*\.?\s*$/i, "");
      return s.trim();
    }

    async function fetchHcpcs(code) {
      code = code.trim().replace(/\s/g, "").toUpperCase();
      if (!code || !/^[A-Z]\d{4}$/.test(code)) return null;

      try {
        const nlmUrl = `${NLM_HCPCS}?terms=${encodeURIComponent(code)}&sf=code&df=code,display&ef=long_desc,short_desc&maxList=20`;
        const data = await fetchJsonExternal(nlmUrl);
        if (Array.isArray(data) && data.length >= 4) {
          const codes = data[1] || [];
          const extraFields = data[2];
          const displayRows = data[3] || [];
          const matchIndex = codes.findIndex(c => String(c).trim().toUpperCase() === code);
          if (matchIndex !== -1) {
            let displayName = "";
            // Prefer long_desc (full description) over short display column
            if (extraFields && typeof extraFields === "object") {
              const longDesc = extraFields.long_desc;
              if (Array.isArray(longDesc) && longDesc[matchIndex] != null) displayName = String(longDesc[matchIndex]).trim();
              else if (longDesc != null) displayName = String(longDesc).trim();
            }
            if (!displayName && matchIndex < displayRows.length && displayRows[matchIndex]) {
              const row = displayRows[matchIndex];
              displayName = Array.isArray(row) && row[1] != null ? String(row[1]).trim() : (row ? String(row).trim() : "");
            }
            if (!displayName && extraFields && typeof extraFields === "object") {
              const shortDesc = extraFields.short_desc;
              if (Array.isArray(shortDesc) && shortDesc[matchIndex] != null) displayName = String(shortDesc[matchIndex]).trim();
              else if (shortDesc != null) displayName = String(shortDesc).trim();
            }
            if (displayName) {
              return {
                display_name: displayName,
                code_label: "HCPCS Code",
                code_value: code,
                source: "NLM Clinical Tables API (HCPCS Level II)",
                term_type: null,
                category: null
              };
            }
          }
        }
      } catch (_) {}

      const url = `https://www.aapc.com/codes/hcpcs-codes/${code}`;
      try {
        const html = await fetchHtmlWithProxyRace(url);
        if (!html) return null;
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        let description = "";
        let category = "";

        const headings = doc.querySelectorAll("h1, h2, h3, h4");
        for (const h of headings) {
          if (/Official\s+Long\s+Descriptor/i.test(h.textContent || "")) {
            let next = h.nextElementSibling;
            while (next) {
              const t = (next.textContent || "").trim();
              if (t.length > 2 && t.length < 500 && !/Codify|Subscribe|Request a Demo/i.test(t)) {
                description = t;
                break;
              }
              next = next.nextElementSibling;
            }
            if (description) break;
          }
        }
        if (!description) {
          const h1 = doc.querySelector("h1");
          const h1Text = h1 ? h1.textContent.trim() : "";
          if (h1Text) {
            description = cleanHcpcsDescription(h1Text, code);
            if (!description) description = h1Text.replace(/^HCPCS\s*Code\s*for\s+/i, "").replace(new RegExp("\\s*" + code + "\\s*$", "i"), "").trim();
          }
        }
        if (!category) {
          const h2 = doc.querySelector("h2");
          const h2Text = h2 ? h2.textContent.trim() : "";
          const underMatch = h2Text.match(/falls?\s+under\s+(.+?)(?:\.|$)/i);
          if (underMatch) category = underMatch[1].trim();
        }
        if (!description) {
          const titleEl = doc.querySelector("title");
          const title = titleEl ? titleEl.textContent.trim() : "";
          if (title && title.includes(" - ")) {
            const parts = title.split(" - ").map(p => p.trim()).filter(Boolean);
            const codifyLast = parts.length > 0 && /Codify\s+by\s+AAPC/i.test(parts[parts.length - 1]);
            if (parts.length >= 2 && !/^HCPCS\s+Codes?\s*$/i.test(parts[0])) {
              description = codifyLast ? parts.slice(1, parts.length - 1).join(" - ") : parts[1];
            }
          }
          if (!description) {
            const metaDesc = doc.querySelector('meta[name="description"]') || doc.querySelector('meta[property="og:description"]');
            if (metaDesc && metaDesc.getAttribute("content")) description = metaDesc.getAttribute("content").trim();
          }
        }
        description = cleanHcpcsDescription(description, code);
        if (!description && category) description = category;
        if (!description) description = "See AAPC.com for full details.";
        return {
          display_name: description,
          code_label: "HCPCS Code",
          code_value: code,
          source: "AAPC (aapc.com)",
          term_type: null,
          category: category ? cleanHcpcsDescription(category, code) || category : null
        };
      } catch (_) {
        return null;
      }
    }

    /** Normalize NDC: accept with or without dashes; display with dashes (5-4-2 or 4-4-2). */
    function normalizeNdc(input) {
      const digits = input.replace(/\D/g, "");
      if (digits.length === 10) return { display: digits.replace(/^(\d{4})(\d{4})(\d{2})$/, "$1-$2-$3") };
      if (digits.length === 11) return { display: digits.replace(/^(\d{5})(\d{4})(\d{2})$/, "$1-$2-$3") };
      return { display: input.trim() };
    }

    async function fetchNdc(code) {
      code = code.trim();
      const normalized = normalizeNdc(code);
      const digits = code.replace(/\D/g, "");
      if (digits.length < 10) return null;
      const ndcParam = normalized.display;
      const url = `${RXNAV_NDC_STATUS}?caller=RxNav&ndc=${encodeURIComponent(ndcParam)}`;
      try {
      let data = await fetchJsonExternal(url);
        const ndcStatus = data && data.ndcStatus ? data.ndcStatus : null;
        if (!ndcStatus || !ndcStatus.conceptName) return null;
        const drugName = (ndcStatus.conceptName || "").trim();
        const rxcui = ndcStatus.rxcui ? String(ndcStatus.rxcui) : null;
        return {
          display_name: drugName,
          code_label: "NDC Code",
          code_value: normalized.display,
          source: "NLM RxNav API",
          term_type: null,
          rxcui: rxcui
        };
      } catch (_) {
        return null;
      }
    }

    async function fetchRxclassAtcDescription(atcCode) {
      const url = `${RXNAV_REST}/rxclass/class/byId.json?classId=${encodeURIComponent(atcCode)}`;
      let data = await fetchJsonExternal(url);
      if (!data) return null;
      const list = data.rxclassMinConceptList;
      const concepts = list && list.rxclassMinConcept;
      const item = Array.isArray(concepts) && concepts[0] ? concepts[0] : (list && list.rxclassMinConceptItem);
      const name = (item && item.className) != null ? String(item.className).trim() : null;
      return name ? String(name).trim() : null;
    }

    /** Resolve ATC name: RxClass for L1‚Äì4, RxNorm drug name or Level 4 class for L5. */
    async function fetchAtcName(atcCode) {
      const code = (atcCode || "").trim().toUpperCase();
      if (!code) return null;

      const rxClassName = await fetchRxclassAtcDescription(code).catch(() => null);
      if (rxClassName) return rxClassName;

      if (code.length === 7) {
        try {
          const data = await fetchJsonExternal(
            `${RXNAV_REST}/rxcui.json?idtype=ATC&id=${encodeURIComponent(code)}`
          );
          const idGroup = data && data.idGroup;
          let rxnormIds = idGroup && idGroup.rxnormId;
          if (rxnormIds) {
            if (!Array.isArray(rxnormIds)) rxnormIds = [rxnormIds];
            if (rxnormIds.length > 0) {
              const name = await fetchRxcuiName(rxnormIds[0]).catch(() => null);
              if (name) return name;
            }
          }
        } catch (_) {}
      }

      if (code.length === 7) {
        const level4Code = code.slice(0, 5);
        const level4Name = await fetchRxclassAtcDescription(level4Code).catch(() => null);
        if (level4Name) return level4Name;
      }

      return null;
    }

    async function getATCNamesForCodes(atcCodes) {
      console.log("[RxCUI‚ÜíATC] Getting names for", atcCodes.length, "codes:", atcCodes);
      const results = await Promise.all(atcCodes.map(async (code) => {
        try {
          console.log("[RxCUI‚ÜíATC] Looking up name for ATC:", code);
          const name = await fetchAtcName(code);
          const out = { code: String(code), name: name || "Name not available" };
          console.log("[RxCUI‚ÜíATC] Name for", code, ":", out.name);
          return out;
        } catch (e) {
          console.warn("[RxCUI‚ÜíATC] Error getting name for", code, e);
          return { code: String(code), name: "Name not available" };
        }
      }));
      return results;
    }

    /** Get ingredient RxCUIs for a drug (for matching in ATC class members). */
    async function fetchIngredientRxcuis(rxcui) {
      const url = `${RXNAV_REST}/rxcui/${rxcui}/related.json?tty=IN`;
      const data = await fetchJsonExternal(url);
      if (!data || !data.relatedGroup || !data.relatedGroup.conceptGroup) return [rxcui];
      const ids = new Set([String(rxcui)]);
      const groups = Array.isArray(data.relatedGroup.conceptGroup) ? data.relatedGroup.conceptGroup : [data.relatedGroup.conceptGroup];
      for (const g of groups) {
        const props = g.conceptProperties;
        const list = Array.isArray(props) ? props : (props ? [props] : []);
        for (const p of list) if (p && p.rxcui) ids.add(String(p.rxcui));
      }
      return Array.from(ids);
    }

    /** Resolve Level 4 ATC (e.g. A10BJ) to Level 5 by fetching class members and matching by rxcui/ingredients. */
    async function resolveLevel5FromClassMembers(rxcui, level4ClassIds) {
      const matchIds = await fetchIngredientRxcuis(rxcui);
      const level5List = [];
      for (const classId of level4ClassIds) {
        if (classId.length !== 5) continue;
        const url = `${RXNAV_REST}/rxclass/classMembers.json?classId=${encodeURIComponent(classId)}&relaSource=ATC`;
        const data = await fetchJsonExternal(url);
        if (!data || !data.drugMemberGroup || !data.drugMemberGroup.drugMember) continue;
        const members = Array.isArray(data.drugMemberGroup.drugMember) ? data.drugMemberGroup.drugMember : [data.drugMemberGroup.drugMember];
        for (const member of members) {
          const mc = member.minConcept;
          const memberRxcui = mc && mc.rxcui != null ? String(mc.rxcui) : null;
          if (!memberRxcui || !matchIds.includes(memberRxcui)) continue;
          const attrs = member.nodeAttr;
          const attrList = Array.isArray(attrs) ? attrs : (attrs ? [attrs] : []);
          let sourceId = null;
          let sourceName = null;
          for (const a of attrList) {
            if (a.attrName === "SourceId") sourceId = a.attrValue;
            if (a.attrName === "SourceName") sourceName = a.attrValue;
          }
          if (sourceId && sourceId.length === 7) {
            level5List.push({ code: sourceId, name: sourceName || "Name not available" });
            break;
          }
        }
      }
      return level5List.length > 0 ? level5List : null;
    }

    async function fetchRxcuiToAtc(rxcui) {
      console.log("[RxCUI‚ÜíATC] === Starting RxCUI to ATC conversion ===");
      console.log("[RxCUI‚ÜíATC] Input RxCUI:", rxcui);

      try {
        const propUrl = `${RXNAV_REST}/rxcui/${rxcui}/property.json?propName=ATC`;
        let data = await fetchJsonExternal(propUrl);

        if (!data) {
          const rxclassUrl = `${RXNAV_REST}/rxclass/class/byRxcui.json?rxcui=${encodeURIComponent(rxcui)}&relaSource=ATC`;
          data = await fetchJsonExternal(rxclassUrl);
          if (!data || !data.rxclassDrugInfoList || !data.rxclassDrugInfoList.rxclassDrugInfo) return null;
          const atcInfo = data.rxclassDrugInfoList.rxclassDrugInfo;
          const atcArray = Array.isArray(atcInfo) ? atcInfo : [atcInfo];
          const atcList = atcArray.map(item => {
            const min = item && item.rxclassMinConceptItem;
            const code = min && min.classId != null ? String(min.classId).trim() : null;
            const name = min && min.className != null ? String(min.className).trim() : "Name not available";
            return code ? { code, name } : null;
          }).filter(Boolean);
          const level5 = atcList.filter(item => item.code.length === 7);
          if (level5.length > 0) return level5;
          const level4Ids = atcList.map(item => item.code).filter(c => c.length === 5);
          if (level4Ids.length > 0) return await resolveLevel5FromClassMembers(rxcui, level4Ids);
          return null;
        }

        const group = data.propConceptGroup;
        if (!group) {
          const rxclassUrl = `${RXNAV_REST}/rxclass/class/byRxcui.json?rxcui=${encodeURIComponent(rxcui)}&relaSource=ATC`;
          data = await fetchJsonExternal(rxclassUrl);
          if (data && data.rxclassDrugInfoList && data.rxclassDrugInfoList.rxclassDrugInfo) {
            const atcArray = Array.isArray(data.rxclassDrugInfoList.rxclassDrugInfo) ? data.rxclassDrugInfoList.rxclassDrugInfo : [data.rxclassDrugInfoList.rxclassDrugInfo];
            const atcList = atcArray.map(item => {
              const min = item && item.rxclassMinConceptItem;
              const code = min && min.classId != null ? String(min.classId).trim() : null;
              const name = min && min.className != null ? String(min.className).trim() : "Name not available";
              return code ? { code, name } : null;
            }).filter(Boolean);
            const level5 = atcList.filter(item => item.code.length === 7);
            if (level5.length > 0) return level5;
            const level4Ids = atcList.map(item => item.code).filter(c => c.length === 5);
            if (level4Ids.length > 0) return await resolveLevel5FromClassMembers(rxcui, level4Ids);
          }
          return null;
        }

        const propConcept = group.propConcept;
        let atcCodes = [];
        if (Array.isArray(propConcept)) {
          atcCodes = propConcept.map(item => (item && item.propValue != null) ? String(item.propValue).trim() : null).filter(Boolean);
        } else if (propConcept && (propConcept.propValue != null || propConcept.propValue === "")) {
          atcCodes = [String(propConcept.propValue).trim()];
        }

        const level5Codes = atcCodes.filter(c => c.length === 7);
        if (level5Codes.length > 0) {
          return await getATCNamesForCodes(level5Codes);
        }
        const level4Codes = atcCodes.filter(c => c.length === 5);
        if (level4Codes.length > 0) {
          return await resolveLevel5FromClassMembers(rxcui, level4Codes);
        }
        return null;
      } catch (e) {
        console.error("[RxCUI‚ÜíATC] Error:", e);
        throw e;
      }
    }

    async function fetchRxcuiName(rxcui) {
      const url = `${RXNAV_REST}/rxcui/${rxcui}/properties.json`;
      let data = await fetchJsonExternal(url);
      if (!data) return null;
      const props = data.properties || data;
      const name = props.name || props.synonym || null;
      return name ? String(name).trim() : null;
    }

    async function fetchNdcToRxcui(ndc) {
      const normalized = normalizeNdc(ndc);
      const url = `${RXNAV_NDC_STATUS}?caller=RxNav&ndc=${encodeURIComponent(normalized.display)}`;
      let data = await fetchJsonExternal(url);
      if (!data) return null;
      const ndcStatus = data.ndcStatus;
      if (!ndcStatus || ndcStatus.rxcui == null) return null;
      return String(ndcStatus.rxcui);
    }

    async function fetchAtcToRxcui(atc) {
      const url = `${RXNAV_REST}/rxcui.json?idtype=ATC&id=${encodeURIComponent(atc)}`;
      let data = await fetchJsonExternal(url);
      if (!data) return null;
      const idGroup = data.idGroup || {};
      let rxnormIds = idGroup.rxnormId;
      if (rxnormIds == null) return [];
      return Array.isArray(rxnormIds) ? rxnormIds.map(String) : [String(rxnormIds)];
    }

    function showCopiedToast(message) {
      const el = document.getElementById("copiedToast");
      if (!el) return;
      el.textContent = message || "Copied!";
      el.classList.remove("show");
      void el.offsetWidth;
      el.classList.add("show");
      clearTimeout(window._copyToastTimer);
      window._copyToastTimer = setTimeout(() => el.classList.remove("show"), 2000);
    }

    function renderConversionResult(originalData, targetType, results, targetLabel) {
      const container = document.getElementById("conversionResult");
      if (!container) return;
      const origLabel = originalData.code_label || "Code";
      const origVal = escapeHtml(originalData.code_value || "‚Äî");
      const origName = escapeHtml(originalData.display_name || "‚Äî");
      const items = Array.isArray(results) ? results : [results];
      const normalized = items.map(r => typeof r === "object" && r && (r.code != null || r.code === "")
        ? { code: String(r.code), name: r.name != null ? String(r.name) : "" }
        : { code: String(r), name: "" });
      const isMultiple = normalized.length > 1;
      let body = "";
      if (isMultiple) {
        const listItems = normalized.map(item => `
          <li>
            <div class="conv-item-content">
              <p class="conv-item-code">‚Ä¢ ${escapeHtml(item.code)}</p>
              ${item.name ? `<p class="conv-item-name">${escapeHtml(item.name)}</p>` : ""}
            </div>
            <button type="button" class="btn-small conversion-copy" data-copy="${escapeHtml(item.code)}">üìã Copy</button>
          </li>`).join("");
        const allCodes = normalized.map(i => i.code).join(", ");
        const copyAllCount = normalized.length;
        body = `
          <p class="conv-result">‚ûú ${escapeHtml(targetLabel)}:</p>
          <ul class="conv-list">${listItems}</ul>
          <div class="conv-actions">
            <button type="button" class="btn-small conversion-copy-all" data-copy="${escapeHtml(allCodes)}" data-count="${copyAllCount}">üìã Copy All Codes</button>
            <button type="button" class="btn-small conversion-back">‚Üê Back</button>
          </div>`;
      } else {
        const single = normalized[0];
        body = `
          <p class="conv-result">‚ûú ${escapeHtml(targetLabel)}: ${escapeHtml(single.code)}</p>
          ${single.name ? `<p class="conv-item-name">${escapeHtml(single.name)}</p>` : ""}
          <div class="conv-actions">
            <button type="button" class="btn-small conversion-copy" data-copy="${escapeHtml(single.code)}">üìã Copy</button>
            <button type="button" class="btn-small conversion-back">‚Üê Back</button>
          </div>`;
      }
      container.innerHTML = `
        <div class="conversion-result-card">
          <p class="conv-title">üîÑ Conversion ${isMultiple ? "Results" : "Result"}</p>
          <p class="conv-original">Original: ${origLabel} ${origVal}</p>
          <p class="conv-original">${origName}</p>
          ${body}
        </div>`;
      container.querySelectorAll(".conversion-copy").forEach(btn => {
        btn.addEventListener("click", () => {
          const copyVal = btn.getAttribute("data-copy");
          if (copyVal) navigator.clipboard.writeText(copyVal).then(() => showCopiedToast("Copied!"));
        });
      });
      const copyAllBtn = container.querySelector(".conversion-copy-all");
      if (copyAllBtn) {
        copyAllBtn.addEventListener("click", () => {
          const copyVal = copyAllBtn.getAttribute("data-copy");
          const count = copyAllBtn.getAttribute("data-count");
          if (copyVal) navigator.clipboard.writeText(copyVal).then(() => showCopiedToast(count ? "Copied " + count + " codes!" : "Copied!"));
        });
      }
      container.querySelector(".conversion-back").addEventListener("click", () => {
        container.innerHTML = "";
        if (lastDrugResult) renderResult(lastDrugResult.data, lastDrugResult.codeType, lastDrugResult.code);
      });
    }

    /** NDC tab: show RxCUI result card + ATC result card below (double convert). */
    function renderNdcDoubleConversionResult(data, rxcuiVal, rxcuiName, atcWithDesc) {
      const container = document.getElementById("conversionResult");
      if (!container) return;
      const ndcVal = escapeHtml(data.code_value || "‚Äî");
      const ndcName = escapeHtml(data.display_name || "‚Äî");
      const rxcuiEsc = escapeHtml(rxcuiVal);
      const nameEsc = escapeHtml(rxcuiName || "Name not available");

      let atcCard = "";
      if (atcWithDesc && atcWithDesc.length > 0) {
        const isMultiple = atcWithDesc.length > 1;
        const items = atcWithDesc.map(r => ({ code: String(r.code), name: r.name != null ? String(r.name) : "" }));
        if (isMultiple) {
          const listItems = items.map(item => `
            <li>
              <div class="conv-item-content">
                <p class="conv-item-code">‚Ä¢ ${escapeHtml(item.code)}</p>
                ${item.name ? `<p class="conv-item-name">${escapeHtml(item.name)}</p>` : ""}
              </div>
              <button type="button" class="btn-small conversion-copy" data-copy="${escapeHtml(item.code)}">üìã Copy</button>
            </li>`).join("");
          const allCodes = items.map(i => i.code).join(", ");
          atcCard = `
            <div class="conversion-result-card" style="margin-top: 1rem;">
              <p class="conv-title">üîÑ ATC Codes (Level 5)</p>
              <p class="conv-original">From RxCUI: ${rxcuiEsc}</p>
              <p class="conv-result">‚ûú ATC Codes (Level 5):</p>
              <ul class="conv-list">${listItems}</ul>
              <div class="conv-actions">
                <button type="button" class="btn-small conversion-copy-all" data-copy="${escapeHtml(allCodes)}" data-count="${items.length}">üìã Copy All Codes</button>
              </div>
            </div>`;
        } else {
          const single = items[0];
          atcCard = `
            <div class="conversion-result-card" style="margin-top: 1rem;">
              <p class="conv-title">üîÑ ATC Code (Level 5)</p>
              <p class="conv-original">From RxCUI: ${rxcuiEsc}</p>
              <p class="conv-result">‚ûú ATC Code (Level 5): ${escapeHtml(single.code)}</p>
              ${single.name ? `<p class="conv-item-name">${escapeHtml(single.name)}</p>` : ""}
              <div class="conv-actions">
                <button type="button" class="btn-small conversion-copy" data-copy="${escapeHtml(single.code)}">üìã Copy</button>
              </div>
            </div>`;
        }
      } else {
        atcCard = `<div class="conversion-empty" style="margin-top: 1rem;">‚ö†Ô∏è Only general ATC classification available (no specific Level 5 codes).</div>`;
      }

      container.innerHTML = `
        <div class="conversion-result-card">
          <p class="conv-title">üîÑ Conversion Result</p>
          <p class="conv-original">Original: NDC ${ndcVal}</p>
          <p class="conv-original">${ndcName}</p>
          <p class="conv-result">‚ûú RxCUI: ${rxcuiEsc}</p>
          <p class="conv-item-name">${nameEsc}</p>
          <div class="conv-actions">
            <button type="button" class="btn-small conversion-copy" data-copy="${rxcuiEsc}">üìã Copy</button>
            <button type="button" class="btn-small conversion-back">‚Üê Back</button>
          </div>
        </div>
        ${atcCard}`;

      container.querySelectorAll(".conversion-copy").forEach(btn => {
        btn.addEventListener("click", () => {
          const copyVal = btn.getAttribute("data-copy");
          if (copyVal) navigator.clipboard.writeText(copyVal).then(() => showCopiedToast("Copied!"));
        });
      });
      const copyAllBtn = container.querySelector(".conversion-copy-all");
      if (copyAllBtn) {
        copyAllBtn.addEventListener("click", () => {
          const copyVal = copyAllBtn.getAttribute("data-copy");
          const count = copyAllBtn.getAttribute("data-count");
          if (copyVal) navigator.clipboard.writeText(copyVal).then(() => showCopiedToast(count ? "Copied " + count + " codes!" : "Copied!"));
        });
      }
      const backBtn = container.querySelector(".conversion-back");
      if (backBtn) {
        backBtn.addEventListener("click", () => {
          container.innerHTML = "";
          if (lastDrugResult) renderResult(lastDrugResult.data, lastDrugResult.codeType, lastDrugResult.code);
        });
      }
    }

    function showConversionError(message, retryFn) {
      const container = document.getElementById("conversionResult");
      if (!container) return;
      container.innerHTML = `<div class="conversion-error">‚ùå ${escapeHtml(message)}${retryFn ? `<br><button type="button" class="chip retry-btn conversion-retry">üîÑ Retry</button>` : ""}</div>`;
      const retryBtn = container.querySelector(".conversion-retry");
      if (retryBtn && retryFn) retryBtn.addEventListener("click", retryFn);
    }

    function showConversionEmpty(customMessage) {
      const container = document.getElementById("conversionResult");
      if (!container) return;
      const msg = customMessage || "No conversion available for this code.";
      container.innerHTML = `<div class="conversion-empty">‚ö†Ô∏è ${escapeHtml(msg)}</div>`;
    }

    function bindConversionButtons() {
      const section = document.getElementById("resultContainer");
      if (!section) return;
      section.querySelectorAll(".conversion-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          if (!lastDrugResult) return;
          const target = btn.getAttribute("data-conversion-target");
          const { data, codeType, code } = lastDrugResult;
          const origCode = (data.code_value || code || "").toString().trim();
          const rxcui = codeType === "RXCUI" ? origCode : (data.rxcui || "");
          const ndc = codeType === "NDC" ? origCode : null;
          const atc = codeType === "ATC" ? (data.code_value || code || "").toString().trim() : null;
          btn.disabled = true;
          const origHtml = btn.innerHTML;
          const loadingText = target === "ATC" ? "Converting RxCUI to ATC codes..." : "Converting...";
          btn.innerHTML = "<span class=\"spinner\" style=\"border-width:2px;width:0.75rem;height:0.75rem;\"></span> " + loadingText;
          const convResult = document.getElementById("conversionResult");
          if (convResult) convResult.innerHTML = "";
          try {
            if (target === "ATC" && rxcui) {
              const atcWithDesc = await fetchRxcuiToAtc(rxcui);
              if (atcWithDesc && atcWithDesc.length > 0) renderConversionResult(data, "ATC", atcWithDesc, atcWithDesc.length === 1 ? "ATC Code (Level 5)" : "ATC Codes (Level 5)");
              else showConversionEmpty("Only general ATC classification available (no specific Level 5 codes).");
            } else if (target === "RXCUI" && ndc) {
              const rxcuiVal = await fetchNdcToRxcui(ndc);
              if (rxcuiVal) {
                btn.innerHTML = "<span class=\"spinner\" style=\"border-width:2px;width:0.75rem;height:0.75rem;\"></span> Fetching RxCUI...";
                const name = await fetchRxcuiName(rxcuiVal).catch(() => null);
                btn.innerHTML = "<span class=\"spinner\" style=\"border-width:2px;width:0.75rem;height:0.75rem;\"></span> Converting to ATC...";
                const atcWithDesc = await fetchRxcuiToAtc(rxcuiVal).catch(() => null);
                renderNdcDoubleConversionResult(data, rxcuiVal, name || "Name not available", atcWithDesc);
              } else showConversionEmpty();
            } else if (target === "RXCUI" && atc) {
              const rxcuiList = await fetchAtcToRxcui(atc);
              if (rxcuiList && rxcuiList.length > 0) {
                btn.innerHTML = "<span class=\"spinner\" style=\"border-width:2px;width:0.75rem;height:0.75rem;\"></span> Fetching details...";
                const withNames = await Promise.all(rxcuiList.map(async (rxcuiId) => {
                  const name = await fetchRxcuiName(rxcuiId).catch(() => null);
                  return { code: rxcuiId, name: name || "Name not available" };
                }));
                renderConversionResult(data, "RXCUI", withNames, "RxCUI Codes");
              } else showConversionEmpty();
            } else {
              showConversionEmpty();
            }
          } catch (e) {
            const errMsg = target === "ATC" ? "Error fetching ATC codes. Please try again." : "Error connecting to conversion service.";
            showConversionError(errMsg, () => {
              convResult.innerHTML = "";
              btn.dispatchEvent(new Event("click"));
            });
          } finally {
            btn.disabled = false;
            btn.innerHTML = origHtml;
          }
        });
      });
    }

    async function lookup(codeType, code) {
      if (codeType === "SNOMED") return await fetchSnomed(code);
      if (codeType === "LOINC") return await fetchLoinc(code);
      if (codeType === "RXCUI") return await fetchRxcui(code);
      if (codeType === "ATC") return await fetchAtc(code);
      if (codeType === "CPT") return await fetchCpt(code);
      if (codeType === "HCPCS") return await fetchHcpcs(code);
      if (codeType === "NDC") return await fetchNdc(code);
      return await fetchIcd(code);
    }

    // ---- Auto-Detect Logic ----
    const DETECT_SYSTEMS = [
      { key: "ICD", label: "ICD-10", fn: fetchIcd },
      { key: "SNOMED", label: "SNOMED CT", fn: fetchSnomed },
      { key: "CPT", label: "CPT", fn: fetchCpt },
      { key: "HCPCS", label: "HCPCS", fn: fetchHcpcs },
      { key: "LOINC", label: "LOINC", fn: fetchLoinc },
      { key: "NDC", label: "NDC", fn: fetchNdc },
      { key: "RXCUI", label: "RxCUI", fn: fetchRxcui },
      { key: "ATC", label: "ATC", fn: fetchAtc }
    ];

    function getProbableSystems(code) {
      const c = code.trim().toUpperCase();
      const candidates = [];
      if (/^[A-TV-Z]\d{2,}\.?\d*$/.test(c)) candidates.push("ICD");
      if (/^\d{5}$/.test(c) || /^\d{4}[A-Z]$/.test(c)) candidates.push("CPT");
      if (/^[A-CEGHJ-VX]\d{4}$/.test(c)) candidates.push("HCPCS");
      if (/^\d{6,18}$/.test(c)) candidates.push("SNOMED");
      if (/^\d+-\d$/.test(c)) candidates.push("LOINC");
      if (/^\d{4,5}-\d{3,4}-\d{1,2}$/.test(c) || /^\d{10,11}$/.test(c)) candidates.push("NDC");
      if (/^\d{3,7}$/.test(c)) candidates.push("RXCUI");
      if (/^[A-Z]\d{2}[A-Z]{0,2}\d{0,2}$/.test(c)) candidates.push("ATC");
      return candidates;
    }

    function getOrderedSystems(code) {
      const probable = getProbableSystems(code);
      if (probable.length > 0) {
        const rest = DETECT_SYSTEMS.filter(s => !probable.includes(s.key));
        const first = probable.map(k => DETECT_SYSTEMS.find(s => s.key === k)).filter(Boolean);
        return [...first, ...rest];
      }
      return [...DETECT_SYSTEMS];
    }

    function renderDetectProgress(systems, statuses) {
      const rows = systems.map((sys, i) => {
        const st = statuses[i] || "pending";
        let icon = "";
        if (st === "checking") icon = '<span class="sys-icon"></span>';
        else if (st === "fail") icon = '<span class="sys-icon">\u274c</span>';
        else if (st === "success") icon = '<span class="sys-icon">\u2705</span>';
        else icon = '<span style="width:.85rem;display:inline-block"></span>';
        const extra = st === "success" ? " Match found!" : "";
        return `<div class="system-row ${st}">${icon} <span>${escapeHtml(sys.label)}${extra}</span></div>`;
      }).join("");
      return `<div class="detect-progress"><h3><span class="detect-spinner"></span> Detecting code type\u2026</h3>${rows}</div>`;
    }

    function renderDetectFail(systems) {
      const rows = systems.map(sys =>
        `<div class="system-row"><span>\u274c</span> <span>${escapeHtml(sys.label)}</span></div>`
      ).join("");
      return `<div class="detect-fail"><h3>\u274c Code not recognized</h3><p style="font-size:.9rem;margin:0 0 1rem 0;color:var(--c-err-fg)">No match found across ICD-10, SNOMED CT, CPT, HCPCS, LOINC, NDC, RxCUI, or ATC. Please verify the code and try again.</p>${rows}</div>`;
    }

    function renderDetectBanner(detectedLabel, detectedId) {
      return `<div class="detect-banner"><p class="banner-title">\u2705 Detected: ${escapeHtml(detectedLabel)}</p><p class="banner-sub">This code was identified as ${escapeHtml(detectedLabel)}. You can also use the <strong>${escapeHtml(detectedLabel)}</strong> tab directly.</p></div>`;
    }

    async function autoDetectLookup(code) {
      const systems = getOrderedSystems(code);
      const statuses = systems.map(() => "pending");
      const container = document.getElementById("resultContainer");
      container.innerHTML = renderDetectProgress(systems, statuses);

      for (let i = 0; i < systems.length; i++) {
        statuses[i] = "checking";
        container.innerHTML = renderDetectProgress(systems, statuses);
        const ctrl = new AbortController();
        _autoDetectSignal = ctrl.signal;
        const timer = setTimeout(() => ctrl.abort(), AUTO_DETECT_TIMEOUT_MS);
        let result = null;
        try {
          result = await systems[i].fn(code);
        } catch (_) {}
        clearTimeout(timer);
        _autoDetectSignal = null;
        if (result && result.display_name && result.display_name !== "\u2014") {
            statuses[i] = "success";
            container.innerHTML = renderDetectProgress(systems, statuses);
            await new Promise(r => setTimeout(r, 600));
            const detectedKey = systems[i].key;
            const detectedLabel = systems[i].label;
            const detectedTabId = Object.entries(CODE_TYPE_TO_API).find(([k, v]) => v === detectedKey);
            const tabId = detectedTabId ? detectedTabId[0] : "icd";
            // Render detection banner + full result
            const bannerHtml = renderDetectBanner(detectedLabel, tabId);
            container.innerHTML = bannerHtml;
            const name = escapeHtml(result.display_name || "\u2014");
            const codeLabel = escapeHtml(result.code_label || "Code");
            const codeVal = escapeHtml(result.code_value || "\u2014");
            const source = escapeHtml(result.source || "\u2014");
            const category = result.category ? escapeHtml(result.category) : "";
            const rxcui = result.rxcui ? escapeHtml(result.rxcui) : "";
            const atcClassName = result.atc_class_name ? escapeHtml(result.atc_class_name) : "";
            const atcClassBlock = atcClassName ? `<p class="source-label">ATC Classification</p><p class="source-value">${atcClassName}</p>` : "";
            const tty = result.term_type;
            const ttyLabel = tty ? (TTY_LABELS[tty.toUpperCase()] || tty) : null;
            const ttyBadge = ttyLabel ? `<span class="badge badge-teal">${escapeHtml(ttyLabel)}</span>` : "";
            const atcLevelLabel = detectedKey === "ATC" && result.code_value ? (ATC_LEVEL_LABELS[result.code_value.length] || null) : null;
            const atcLevelBadge = atcLevelLabel ? `<span class="badge badge-teal">${escapeHtml(atcLevelLabel)}</span>` : "";
            const categoryBlock = category ? `<p class="source-label">Category</p><p class="source-value">${category}</p>` : "";
            const rxcuiBlock = rxcui ? `<p class="source-label">RxCUI</p><p class="source-value">${rxcui}</p>` : "";
            const isDrug = detectedKey === "RXCUI" || detectedKey === "NDC" || detectedKey === "ATC";
            if (isDrug) lastDrugResult = { data: result, codeType: detectedKey, code: code || result.code_value };
            else lastDrugResult = null;
            const conversionHtml = isDrug ? buildConversionSection(detectedKey, result.display_name, codeVal) : "";
            container.innerHTML = bannerHtml + `
              <div class="result-card">
                <p class="display-name">${name}</p>
                <div class="badges">
                  <span class="badge">${codeLabel}: ${codeVal}</span>${ttyBadge}${atcLevelBadge}
                </div>
                ${categoryBlock}
                ${rxcuiBlock}
                ${atcClassBlock}
                <p class="source-label">Source</p>
                <p class="source-value">${source}</p>
              </div>${conversionHtml}`;
            if (isDrug) bindConversionButtons();
            // Update edu card to match detected type
            updateEduCardForType(detectedKey);
            addToHistory(detectedLabel, code, result.display_name);
            return result;
        }
        statuses[i] = "fail";
        container.innerHTML = renderDetectProgress(systems, statuses);
      }
      // No match found
      container.innerHTML = renderDetectFail(systems);
      return null;
    }

    function renderCodeTypeChips() {
      const container = document.getElementById("codeTypeChips");
      const descEl = document.getElementById("codeTypeDescription");
      if (!container) return;
      container.innerHTML = CODE_TYPES.map((t, i) => `
        <input type="radio" name="codeType" id="r_${t.id}" value="${escapeHtml(t.id)}" ${i === 0 ? "checked" : ""}>
        <label for="r_${t.id}">${escapeHtml(t.label)}</label>
      `).join("");
      function updateDescription() {
        const selected = document.querySelector('input[name="codeType"]:checked');
        const id = selected ? selected.value : CODE_TYPES[0].id;
        const item = CODE_TYPES.find(t => t.id === id) || CODE_TYPES[0];
        if (descEl) {
          descEl.textContent = item.description;
          descEl.classList.remove("fade-in");
          void descEl.offsetWidth;
          descEl.classList.add("fade-in");
        }
      }
      updateDescription();
      container.querySelectorAll('input[name="codeType"]').forEach(r => {
        r.addEventListener("change", () => {
          updateDescription();
          updateExamples();
          clearMessage();
          document.getElementById("resultContainer").innerHTML = "";
          handleDiagnosisSearchVisibility();
          updateEduCardForType();
        });
      });
      handleDiagnosisSearchVisibility();
      updateEduCardForType();
    }

    function clearSearch() {
      const input = document.getElementById("diagnosisNameInput");
      const results = document.getElementById("searchResults");
      const clearBtn = document.getElementById("clearSearchBtn");
      if (input) input.value = "";
      if (results) results.style.display = "none";
      if (clearBtn) clearBtn.style.display = "none";
    }

    function updateSearchSectionLabels(typeId) {
      const sectionTitle = document.querySelector("#diagnosisSearchSection h2");
      const sectionSubtitle = document.querySelector("#diagnosisSearchSection .subtitle");
      const searchInput = document.getElementById("diagnosisNameInput");
      const examplesContainer = document.querySelector("#diagnosisSearchSection .example-searches");
      if (typeId === "icd") {
        if (sectionTitle) sectionTitle.textContent = "üîç Search by Diagnosis Name";
        if (sectionSubtitle) sectionSubtitle.textContent = "Search ICD-10 codes by typing a condition or symptom (e.g., diabetes, headache, chest pain)";
        if (searchInput) searchInput.placeholder = "Enter diagnosis or symptom...";
        if (examplesContainer) {
          examplesContainer.innerHTML = `<span class="label">Try:</span>
        <button type="button" class="example-btn" data-term="diabetes">diabetes</button>
        <button type="button" class="example-btn" data-term="headache">headache</button>
        <button type="button" class="example-btn" data-term="chest pain">chest pain</button>
        <button type="button" class="example-btn" data-term="hypertension">hypertension</button>
        <button type="button" class="example-btn" data-term="flu">flu</button>
        <button type="button" class="example-btn" data-term="fever">fever</button>
        <button type="button" class="example-btn" data-term="cough">cough</button>
        <button type="button" class="example-btn" data-term="asthma">asthma</button>`;
        }
      } else if (typeId === "loinc") {
        if (sectionTitle) sectionTitle.textContent = "üîç Search by Lab or Observation Name";
        if (sectionSubtitle) sectionSubtitle.textContent = "Search LOINC codes by test name or observation (e.g., glucose, hemoglobin, creatinine, sodium)";
        if (searchInput) searchInput.placeholder = "Enter lab test or observation name...";
        if (examplesContainer) {
          examplesContainer.innerHTML = `<span class="label">Try:</span>
        <button type="button" class="example-btn" data-term="glucose">glucose</button>
        <button type="button" class="example-btn" data-term="hemoglobin">hemoglobin</button>
        <button type="button" class="example-btn" data-term="creatinine">creatinine</button>
        <button type="button" class="example-btn" data-term="sodium">sodium</button>
        <button type="button" class="example-btn" data-term="potassium">potassium</button>
        <button type="button" class="example-btn" data-term="cholesterol">cholesterol</button>
        <button type="button" class="example-btn" data-term="white blood">white blood</button>
        <button type="button" class="example-btn" data-term="troponin">troponin</button>`;
        }
      }
      bindExampleSearchButtons();
    }

    function bindExampleSearchButtons() {
      const exampleBtns = document.querySelectorAll("#diagnosisSearchSection .example-btn");
      const input = document.getElementById("diagnosisNameInput");
      const clearBtn = document.getElementById("clearSearchBtn");
      exampleBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          const term = btn.getAttribute("data-term") || "";
          input.value = term;
          clearBtn.style.display = "block";
          searchByDiagnosisName(term);
        });
      });
    }

    function handleDiagnosisSearchVisibility() {
      const selected = document.querySelector('input[name="codeType"]:checked');
      const typeId = selected ? selected.value : "icd";
      const section = document.getElementById("diagnosisSearchSection");
      if (!section) return;
      if ((typeId === "icd" || typeId === "loinc") && typeId !== "auto") {
        section.style.display = "block";
        updateSearchSectionLabels(typeId);
      } else {
        section.style.display = "none";
        clearSearch();
      }
    }

    function updateExamples() {
      const selected = document.querySelector('input[name="codeType"]:checked');
      const typeId = selected ? selected.value : "auto";
      const apiKey = CODE_TYPE_TO_API[typeId];
      const list = apiKey ? (EXAMPLES[apiKey] || []) : [];
      const input = document.getElementById("codeInput");
      const container = document.getElementById("exampleChips");
      const lookupBtn = document.getElementById("lookupBtn");
      const isAuto = typeId === "auto";
      container.innerHTML = list.map(c =>
        `<button type="button" class="chip" data-code="${c.replace(/"/g, "&quot;")}">${c.replace(/</g, "&lt;")}</button>`
      ).join("");
      container.querySelectorAll(".chip").forEach(btn => {
        btn.addEventListener("click", () => {
          input.value = btn.dataset.code;
          input.focus();
          lookupBtn.click();
        });
      });
      if (isAuto) {
        input.placeholder = "Enter any medical code (e.g., E11.9, 73211009, 99213, J0171)";
        lookupBtn.innerHTML = '<i class="fa-solid fa-magnifying-glass mr-2 text-sm"></i>Detect & Lookup';
      } else {
        input.placeholder = list[0] ? `e.g. ${list[0]}` : "Enter code";
        lookupBtn.innerHTML = '<i class="fa-solid fa-magnifying-glass mr-2 text-sm"></i>Lookup';
      }
    }

    renderCodeTypeChips();
    updateExamples();
    renderHistory();

    function debounce(fn, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    let diagnosisSearchController = null;
    const ICD10_SEARCH_API = "https://clinicaltables.nlm.nih.gov/api/icd10cm/v3/search";

    async function searchByDiagnosisName(term) {
      const t = (term || "").trim();
      if (t.length < 2) {
        document.getElementById("searchResults").style.display = "none";
        return;
      }
      const selected = document.querySelector('input[name="codeType"]:checked');
      const typeId = selected ? selected.value : "icd";
      if (typeId !== "icd" && typeId !== "loinc") return;
      const searchResults = document.getElementById("searchResults");
      const loadingEl = document.getElementById("searchLoading");
      if (diagnosisSearchController) diagnosisSearchController.abort();
      diagnosisSearchController = new AbortController();
      loadingEl.style.display = "block";
      searchResults.style.display = "none";
      try {
        if (typeId === "loinc") {
          const apiUrl = `${LOINC_URL}?terms=${encodeURIComponent(t)}&maxList=15`;
          let data = await fetchJson(apiUrl, { signal: diagnosisSearchController.signal });
          if (!data) data = await fetchJsonWithProxy(apiUrl);
          loadingEl.style.display = "none";
          const codes = Array.isArray(data && data[1]) ? data[1] : [];
          const displays = Array.isArray(data && data[3]) ? data[3] : [];
          const list = codes.map((code, i) => {
            const desc = displays[i] != null ? (Array.isArray(displays[i]) ? (displays[i][0] != null ? String(displays[i][0]).trim() : "") : String(displays[i]).trim()) : "";
            return [String(code).trim(), desc];
          }).filter(pair => pair[0]);
          if (list.length === 0) {
            displayDiagnosisNoResults(t, typeId);
            return;
          }
          displayDiagnosisResults(list, typeId);
        } else {
          const apiUrl = `${ICD10_SEARCH_API}?sf=code,name&terms=${encodeURIComponent(t)}&maxList=15`;
          let data = await fetchJson(apiUrl, { signal: diagnosisSearchController.signal });
          if (!data) data = await fetchJsonWithProxy(apiUrl);
          loadingEl.style.display = "none";
          const pairs = Array.isArray(data && data[3]) && data[3].length > 0 ? data[3] : null;
          const list = pairs || (Array.isArray(data && data[1]) && data[1].length > 0 && Array.isArray(data[1][0]) ? data[1] : null);
          if (!list || list.length === 0) {
            displayDiagnosisNoResults(t, typeId);
            return;
          }
          displayDiagnosisResults(list, typeId);
        }
      } catch (err) {
        if (err.name === "AbortError") return;
        loadingEl.style.display = "none";
        searchResults.innerHTML = `<div class="search-no-results"><div class="search-no-results-icon">‚ùå</div><p>Error searching. Please try again.</p></div>`;
        searchResults.style.display = "block";
      }
    }

    function displayDiagnosisResults(list, typeId) {
      const searchResults = document.getElementById("searchResults");
      const count = list.length;
      const typeEsc = escapeHtml(typeId === "snomed" ? "snomed" : typeId === "loinc" ? "loinc" : "icd");
      let html = `<p class="search-results-count">Found ${count} result${count !== 1 ? "s" : ""}</p>`;
      list.forEach(item => {
        const code = Array.isArray(item) ? (item[0] != null ? String(item[0]).trim() : "") : "";
        const desc = Array.isArray(item) && item[1] != null ? String(item[1]).trim() : "";
        const codeEsc = escapeHtml(code);
        const descEsc = escapeHtml(desc);
        html += `<div class="diagnosis-result-item" role="option" data-code="${codeEsc}" data-description="${descEsc.replace(/"/g, "&quot;")}" data-typeid="${typeEsc}" tabindex="0">`;
        html += `<div class="diagnosis-result-code">${codeEsc}</div>`;
        html += `<div class="diagnosis-result-desc">${descEsc}</div></div>`;
      });
      searchResults.innerHTML = html;
      searchResults.style.display = "block";
      searchResults.querySelectorAll(".diagnosis-result-item").forEach(el => {
        const tid = el.dataset.typeid || "icd";
        el.addEventListener("click", () => selectSearchResult(el.dataset.code, el.dataset.description, tid));
        el.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); selectSearchResult(el.dataset.code, el.dataset.description, tid); } });
      });
    }

    function displayDiagnosisNoResults(term, typeId) {
      const searchResults = document.getElementById("searchResults");
      const termEsc = escapeHtml(term);
      const codeTypeName = typeId === "snomed" ? "SNOMED CT" : typeId === "loinc" ? "LOINC" : "ICD-10";
      searchResults.innerHTML = `<div class="search-no-results"><div class="search-no-results-icon">üîç</div><p>No ${escapeHtml(codeTypeName)} codes found${term ? ` for "<strong>${termEsc}</strong>"` : ""}</p><p style="font-size:13px;margin-top:8px;">Try:</p><ul style="font-size:13px;color:var(--text-muted);text-align:left;margin-top:8px;"><li>Different spelling or terminology</li><li>More general terms (e.g., "diabetes" instead of "diabetic neuropathy")</li><li>Common medical terms or symptoms</li></ul></div>`;
      searchResults.style.display = "block";
    }

    function selectSearchResult(code, description, typeId) {
      document.getElementById("diagnosisNameInput").value = "";
      document.getElementById("searchResults").style.display = "none";
      document.getElementById("clearSearchBtn").style.display = "none";
      const radio = document.getElementById("r_" + (typeId || "icd"));
      const codeInput = document.getElementById("codeInput");
      if (radio && codeInput) {
        radio.checked = true;
        radio.dispatchEvent(new Event("change", { bubbles: true }));
        codeInput.value = code;
        codeInput.focus();
        document.getElementById("lookupBtn").click();
        setTimeout(() => {
          const resultContainer = document.getElementById("resultContainer");
          if (resultContainer) resultContainer.scrollIntoView({ behavior: "smooth", block: "start" });
        }, 100);
      }
    }

    function initializeDiagnosisSearch() {
      const input = document.getElementById("diagnosisNameInput");
      const clearBtn = document.getElementById("clearSearchBtn");
      if (!input) return;
      const debouncedSearch = debounce(searchByDiagnosisName, 300);
      input.addEventListener("input", () => {
        const v = input.value;
        clearBtn.style.display = v.length > 0 ? "block" : "none";
        debouncedSearch(v);
      });
      clearBtn.addEventListener("click", () => {
        clearSearch();
        input.focus();
      });
      bindExampleSearchButtons();
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const v = input.value.trim();
          if (v.length >= 2) searchByDiagnosisName(v);
        }
      });
    }
    initializeDiagnosisSearch();

    document.getElementById("lookupBtn").addEventListener("click", async () => {
      const selected = document.querySelector('input[name="codeType"]:checked');
      const typeId = selected ? selected.value : "auto";
      const apiKey = CODE_TYPE_TO_API[typeId];
      let code = document.getElementById("codeInput").value.trim();
      const typeLabel = (CODE_TYPES.find(t => t.id === typeId) || {}).label || typeId;
      clearMessage();
      document.getElementById("resultContainer").innerHTML = "";
      if (!code) {
        showMessage("Please enter a code.", "error");
        return;
      }
      // Auto-Detect mode
      if (apiKey === "AUTO") {
        setLoading(true);
        try {
          const result = await autoDetectLookup(code);
          if (result) {
            showMessage("Found.", "success");
          }
        } catch (e) {
          showMessage("Network error during auto-detection. Please try again.", "error");
        } finally {
          setLoading(false);
        }
        return;
      }
      if (apiKey === "HCPCS") {
        code = code.replace(/\s/g, "").toUpperCase();
        if (!/^[A-Z]\d{4}$/.test(code)) {
          showMessage("Invalid HCPCS format. Use one letter followed by 4 digits (e.g. A4244, J0135, E0118).", "error");
          return;
        }
        document.getElementById("codeInput").value = code;
      }
      setLoading(true);
      try {
        const result = await Promise.race([lookup(apiKey, code), lookupTimeout(LOOKUP_TIMEOUT_MS)]);
        if (result) {
          showMessage("Found.", "success");
          renderResult(result, apiKey, code);
          addToHistory(typeLabel, code, result.display_name);
        } else {
          showMessage(`Could not find ${typeLabel} code: ${code}. Check the code and try again.`, "error");
        }
      } catch (e) {
        if (e && e.message === "LOOKUP_TIMEOUT") {
          showMessage("Lookup timed out after 8 seconds. Please try again or check your connection.", "error");
        } else {
          showMessage("Network or CORS error. Try running the page from a local server (e.g. <code>python -m http.server</code>) or check your connection.", "error");
        }
      } finally {
        setLoading(false);
      }
    });

    document.getElementById("codeInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") document.getElementById("lookupBtn").click();
    });
  </script>
  <script>
  // Theme Toggle
  (function(){
    var toggle=document.getElementById('themeToggle');
    var html=document.documentElement;
    var saved=localStorage.getItem('theme');
    if(saved==='light')html.classList.remove('dark');
    else if(saved==='dark')html.classList.add('dark');
    toggle.addEventListener('click',function(){
      html.classList.toggle('dark');
      localStorage.setItem('theme',html.classList.contains('dark')?'dark':'light');
    });
  })();
  // Floating Particles
  (function(){
    var canvas=document.getElementById('bgCanvas');
    var ctx=canvas.getContext('2d');
    var particles=[];
    var N=60;
    function resize(){canvas.width=window.innerWidth;canvas.height=window.innerHeight}
    resize();window.addEventListener('resize',resize);
    function create(){return{x:Math.random()*canvas.width,y:Math.random()*canvas.height,s:Math.random()*2.5+.5,vx:(Math.random()-.5)*.4,vy:(Math.random()-.5)*.4,o:Math.random()*.4+.1,p:Math.random()*Math.PI*2,ps:Math.random()*.02+.005}}
    for(var i=0;i<N;i++)particles.push(create());
    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      for(var i=0;i<particles.length;i++){
        var p=particles[i];p.x+=p.vx;p.y+=p.vy;p.p+=p.ps;
        var op=p.o*(.6+.4*Math.sin(p.p));
        if(p.x<-10)p.x=canvas.width+10;if(p.x>canvas.width+10)p.x=-10;
        if(p.y<-10)p.y=canvas.height+10;if(p.y>canvas.height+10)p.y=-10;
        ctx.beginPath();ctx.arc(p.x,p.y,p.s,0,Math.PI*2);
        ctx.fillStyle='rgba(167,139,250,'+op+')';ctx.fill();
      }
      for(var i=0;i<particles.length;i++){
        for(var j=i+1;j<particles.length;j++){
          var dx=particles[i].x-particles[j].x,dy=particles[i].y-particles[j].y;
          var d=Math.sqrt(dx*dx+dy*dy);
          if(d<150){ctx.beginPath();ctx.moveTo(particles[i].x,particles[i].y);ctx.lineTo(particles[j].x,particles[j].y);ctx.strokeStyle='rgba(124,58,237,'+(0.06*(1-d/150))+')';ctx.lineWidth=.5;ctx.stroke()}
        }
      }
      requestAnimationFrame(draw);
    }
    draw();
  })();
  </script>
</body>
</html>
